<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Maxwell's Notebook: The Capacitor (2D)</title>
    <!-- Load KaTeX for Math Rendering -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/katex.min.css">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/katex.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/contrib/auto-render.min.js"
        onload="renderMathInElement(document.body);"></script>

    <style>
        :root {
            --bg: #151515;
            --panel: #1e1e1e;
            --text: #dcdcdc;
            --accent: #ff9f43;
            /* Maxwell Orange */
            --accent-hover: #e58e3c;
            --energy: #00cec9;
            /* Cyan for Energy */
            --pos-charge: #ff5e57;
            --neg-charge: #48dbfb;
            --field: #ffdd59;
            --border: #333;
        }

        body {
            margin: 0;
            height: 100vh;
            display: flex;
            background: var(--bg);
            color: var(--text);
            font-family: 'Segoe UI', sans-serif;
            overflow: hidden;
        }

        /* --- SIDEBAR --- */
        aside {
            width: 420px;
            background: var(--panel);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            z-index: 10;
            box-shadow: 10px 0 30px rgba(0, 0, 0, 0.5);
        }

        header {
            padding: 20px;
            background: rgba(0, 0, 0, 0.2);
            border-bottom: 1px solid var(--border);
        }

        h1 {
            margin: 0;
            font-size: 18px;
            color: var(--accent);
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .subtitle {
            font-size: 12px;
            color: #888;
            margin-top: 5px;
        }

        #story-container {
            flex: 1;
            padding: 25px;
            overflow-y: auto;
        }

        .chapter-title {
            font-size: 22px;
            color: #fff;
            margin-bottom: 15px;
            border-left: 3px solid var(--accent);
            padding-left: 10px;
        }

        .text-content {
            line-height: 1.6;
            font-size: 14px;
            color: #ccc;
            text-align: justify;
            margin-bottom: 15px;
        }

        .math-block {
            background: #222;
            padding: 10px;
            border-radius: 4px;
            border: 1px solid #333;
            text-align: center;
            margin: 15px 0;
            color: var(--energy);
        }

        /* --- CONTROLS --- */
        #controls {
            background: #111;
            padding: 20px;
            border-top: 1px solid var(--border);
        }

        .slider-container {
            margin-bottom: 15px;
        }

        .slider-label {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: #aaa;
            margin-bottom: 5px;
        }

        input[type=range] {
            width: 100%;
            cursor: pointer;
            accent-color: var(--accent);
        }

        button {
            background: #2a2a2a;
            color: #fff;
            border: 1px solid #444;
            padding: 12px;
            width: 100%;
            cursor: pointer;
            font-weight: bold;
            transition: 0.2s;
            text-transform: uppercase;
            font-size: 12px;
            margin-bottom: 10px;
        }

        button:hover {
            background: var(--accent);
            color: #111;
            border-color: var(--accent);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        #nav {
            padding: 15px;
            display: flex;
            gap: 10px;
            background: #000;
            border-top: 1px solid var(--border);
        }

        .nav-btn {
            flex: 1;
        }

        .next-btn {
            background: var(--accent);
            color: #111;
            border: none;
        }

        .next-btn:hover {
            background: #ffb875;
        }

        /* --- VIEWPORT --- */
        main {
            flex: 1;
            position: relative;
            background: radial-gradient(circle at center, #1a1a1a 0%, #080808 100%);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        canvas {
            box-shadow: 0 0 50px rgba(0, 0, 0, 0.5);
            border-radius: 4px;
        }

        /* HUD OVERLAY */
        #hud {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(20, 20, 20, 0.9);
            border: 1px solid #444;
            border-radius: 8px;
            padding: 15px;
            width: 200px;
            font-family: 'Segoe UI', sans-serif;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.5s;
        }

        .hud-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 6px;
            font-size: 12px;
            color: #aaa;
        }

        .hud-val {
            font-weight: bold;
            color: #fff;
            font-family: monospace;
        }

        .hud-hl {
            color: var(--accent);
        }
    </style>
</head>

<body>

    <aside>
        <header>
            <h1>Maxwell's Notebook</h1>
            <div class="subtitle">Chapter 6: Parallel Plate Capacitor (2D)</div>
        </header>
        <div id="story-container"></div>
        <div id="controls">
            <div id="dynamic-controls"></div>
        </div>
        <div id="nav">
            <button class="nav-btn" onclick="prevStep()">Back</button>
            <button class="nav-btn next-btn" id="btn-next" onclick="nextStep()">Next</button>
        </div>
    </aside>

    <main id="viewport">
        <canvas id="simCanvas"></canvas>
        <div id="hud">
            <div class="hud-row"><span>Voltage (V):</span> <span class="hud-val hud-hl" id="disp-v">0 V</span></div>
            <div class="hud-row"><span>Distance (d):</span> <span class="hud-val" id="disp-d">2.0 mm</span></div>
            <div class="hud-row"><span>Charge (Q):</span> <span class="hud-val" id="disp-q">0.0 C</span></div>
            <div class="hud-row"><span>E-Field (E):</span> <span class="hud-val" id="disp-e">0.0 N/C</span></div>
            <div style="border-top:1px solid #444; margin-top:5px; padding-top:5px;" class="hud-row">
                <span style="color:var(--energy)">Energy (U):</span> <span class="hud-val" style="color:var(--energy)"
                    id="disp-u">0.0 J</span>
            </div>
        </div>
    </main>

    <script>
        // --- SIMULATION CONFIG ---
        const config = {
            voltage: 0,       // 0 to 10
            distance: 100,    // Pixels (representing mm)
            plateWidth: 400,
            plateHeight: 20,
            showField: false,
            showCircuit: false,
            showEnergy: false
        };

        // --- CANVAS SETUP ---
        const canvas = document.getElementById('simCanvas');
        const ctx = canvas.getContext('2d');

        // Physics State
        let physics = {
            C: 0,
            Q: 0,
            E: 0,
            U: 0
        };

        // Resize Canvas
        function resize() {
            const parent = document.getElementById('viewport');
            canvas.width = parent.offsetWidth - 40;
            canvas.height = parent.offsetHeight - 40;
        }
        window.addEventListener('resize', resize);
        resize();

        // --- DRAWING FUNCTIONS ---

        function drawPlate(x, y, w, h, isTop) {
            // Metallic Gradient
            const grad = ctx.createLinearGradient(x, y, x, y + h);
            grad.addColorStop(0, '#555');
            grad.addColorStop(0.5, '#777');
            grad.addColorStop(1, '#555');

            ctx.fillStyle = grad;
            ctx.strokeStyle = '#222';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.roundRect(x, y, w, h, 4);
            ctx.fill();
            ctx.stroke();

            // Terminal connection point
            ctx.fillStyle = '#333';
            ctx.beginPath();
            if (isTop) ctx.arc(x + w / 2, y, 4, 0, Math.PI * 2);
            else ctx.arc(x + w / 2, y + h, 4, 0, Math.PI * 2);
            ctx.fill();
        }

        function drawCharges(centerX, centerY, separation) {
            if (Math.abs(physics.Q) < 0.1) return;

            const count = Math.min(Math.abs(physics.Q) * 5, 40); // Visual limit
            const startX = centerX - config.plateWidth / 2 + 20;
            const width = config.plateWidth - 40;
            const step = width / (count > 0 ? count : 1);

            // Top Plate Position (Inner surface)
            const topY = centerY - separation / 2 + config.plateHeight + 8;
            // Bottom Plate Position (Inner surface)
            const botY = centerY + separation / 2 - config.plateHeight - 8;

            for (let i = 0; i <= count; i++) {
                const x = startX + i * step;

                // Top Charges (Opposite sign if V < 0, but lets assume standard polarity V>0 means Top+)
                const topColor = config.voltage >= 0 ? '#ff5e57' : '#48dbfb'; // Red (+) or Blue (-)
                const botColor = config.voltage >= 0 ? '#48dbfb' : '#ff5e57';
                const topSign = config.voltage >= 0 ? "+" : "-";
                const botSign = config.voltage >= 0 ? "-" : "+";

                // Draw Top
                ctx.fillStyle = topColor;
                ctx.shadowBlur = 5;
                ctx.shadowColor = topColor;
                ctx.beginPath(); ctx.arc(x, topY, 4, 0, Math.PI * 2); ctx.fill();
                ctx.shadowBlur = 0;
                ctx.font = "10px monospace"; ctx.textAlign = "center"; ctx.textBaseline = "middle";
                ctx.fillStyle = "#fff"; ctx.fillText(topSign, x, topY + 0.5);

                // Draw Bottom
                ctx.fillStyle = botColor;
                ctx.shadowBlur = 5;
                ctx.shadowColor = botColor;
                ctx.beginPath(); ctx.arc(x, botY, 4, 0, Math.PI * 2); ctx.fill();
                ctx.shadowBlur = 0;
                ctx.fillStyle = "#fff"; ctx.fillText(botSign, x, botY + 0.5);
            }
        }

        function drawField(centerX, centerY, separation) {
            if (!config.showField || Math.abs(physics.E) < 0.1) return;

            const startY = centerY - separation / 2 + config.plateHeight;
            const endY = centerY + separation / 2 - config.plateHeight;

            // Opacity based on Field Strength
            const alpha = Math.min(Math.abs(physics.E) / 5, 1);
            ctx.globalAlpha = alpha;
            ctx.strokeStyle = '#ffdd59';
            ctx.lineWidth = 2;

            const count = 12; // Number of field lines
            const startX = centerX - config.plateWidth / 2 + 30;
            const spacing = (config.plateWidth - 60) / (count - 1);

            for (let i = 0; i < count; i++) {
                const x = startX + i * spacing;

                ctx.beginPath();
                ctx.moveTo(x, startY + 5);
                ctx.lineTo(x, endY - 5);
                ctx.stroke();

                // Arrowhead
                const arrowSize = 6;
                const dir = config.voltage >= 0 ? 1 : -1;
                const arrowY = config.voltage >= 0 ? endY - 8 : startY + 8;

                ctx.beginPath();
                ctx.moveTo(x, arrowY);
                ctx.lineTo(x - 4, arrowY - (dir * 6));
                ctx.lineTo(x + 4, arrowY - (dir * 6));
                ctx.closePath();
                ctx.fillStyle = '#ffdd59';
                ctx.fill();
            }
            ctx.globalAlpha = 1.0;
        }

        function drawEnergyGlow(centerX, centerY, separation) {
            if (!config.showEnergy || Math.abs(physics.Q) < 0.1) return;

            const startY = centerY - separation / 2 + config.plateHeight;
            const height = separation - (2 * config.plateHeight);

            // Density is proportional to E^2. 
            // We visualize this with opacity.
            let opacity = Math.min((physics.E * physics.E) / 50, 0.7);

            const grad = ctx.createLinearGradient(0, startY, 0, startY + height);
            grad.addColorStop(0, `rgba(0, 206, 201, 0)`);
            grad.addColorStop(0.2, `rgba(0, 206, 201, ${opacity})`); // Cyan
            grad.addColorStop(0.8, `rgba(0, 206, 201, ${opacity})`);
            grad.addColorStop(1, `rgba(0, 206, 201, 0)`);

            ctx.fillStyle = grad;
            // Limit glow to width of plates
            ctx.fillRect(centerX - config.plateWidth / 2, startY, config.plateWidth, height);
        }

        function drawCircuit(centerX, centerY, separation) {
            if (!config.showCircuit) return;

            const plateTopY = centerY - separation / 2;
            const plateBotY = centerY + separation / 2 + config.plateHeight;
            const batteryX = centerX - 300; // Place battery to the left

            ctx.strokeStyle = '#555';
            ctx.lineWidth = 3;
            ctx.beginPath();

            // Top Wire
            ctx.moveTo(centerX, plateTopY);
            ctx.lineTo(centerX, plateTopY - 50);
            ctx.lineTo(batteryX, plateTopY - 50);
            ctx.lineTo(batteryX, centerY - 20);

            // Bottom Wire
            ctx.moveTo(centerX, plateBotY);
            ctx.lineTo(centerX, plateBotY + 50);
            ctx.lineTo(batteryX, plateBotY + 50);
            ctx.lineTo(batteryX, centerY + 20);
            ctx.stroke();

            // Battery Symbol
            ctx.lineWidth = 4;
            ctx.strokeStyle = '#fff';

            // Top Plate of Battery (Long line if V>0, actually simple symbol: Long Top, Short Bottom)
            ctx.beginPath();
            ctx.moveTo(batteryX - 20, centerY - 10);
            ctx.lineTo(batteryX + 20, centerY - 10);
            ctx.stroke();

            ctx.lineWidth = 6; // Thick short line
            ctx.beginPath();
            ctx.moveTo(batteryX - 10, centerY + 10);
            ctx.lineTo(batteryX + 10, centerY + 10);
            ctx.stroke();

            // Voltage Text
            ctx.fillStyle = '#aaa';
            ctx.font = "14px monospace";
            ctx.textAlign = "right";
            ctx.fillText("V_source", batteryX - 30, centerY + 5);
        }

        // --- MAIN LOOP ---

        function loop() {
            // Clear
            ctx.fillStyle = "#0a0a0a"; // slightly lighter than bg for contrast
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            const cx = canvas.width / 2;
            const cy = canvas.height / 2;

            // Calculate Physics
            // Simplify constants: epsilon_0 = 1, A = 100
            // C = A / d
            physics.C = (1000 / config.distance);
            physics.Q = physics.C * (config.voltage / 10); // Scale down V
            physics.E = (config.voltage * 200) / config.distance; // E = V/d
            physics.U = 0.5 * physics.C * Math.pow(config.voltage / 10, 2) * 100; // Scale up for display

            // Draw Sequence
            drawCircuit(cx, cy, config.distance);
            drawEnergyGlow(cx, cy, config.distance);

            // Draw Plates
            const halfD = config.distance / 2;
            drawPlate(cx - config.plateWidth / 2, cy - halfD, config.plateWidth, config.plateHeight, true);
            drawPlate(cx - config.plateWidth / 2, cy + halfD - config.plateHeight, config.plateWidth, config.plateHeight, false);

            drawCharges(cx, cy, config.distance);
            drawField(cx, cy, config.distance);

            // Update HUD
            if (config.showCircuit) {
                document.getElementById('disp-v').innerText = config.voltage.toFixed(1) + " V";
                document.getElementById('disp-d').innerText = (config.distance / 10).toFixed(1) + " mm";
                document.getElementById('disp-q').innerText = physics.Q.toFixed(1) + " nC";
                document.getElementById('disp-e').innerText = physics.E.toFixed(1) + " kV/m";
                document.getElementById('disp-u').innerText = physics.U.toFixed(2) + " uJ";
            }

            requestAnimationFrame(loop);
        }
        loop();


        // --- STORY ENGINE ---
        const steps = [
            {
                title: "The Conductors",
                text: "This is a cross-section of a capacitor. It consists of two parallel conductive plates separated by a distance $d$.<br><br>Initially, the plates are neutral. They contain equal amounts of positive and negative charge, so the net charge is zero. There is no interaction between them.",
                controls: ``,
                setup: () => {
                    config.voltage = 0;
                    config.distance = 120;
                    config.showCircuit = false;
                    config.showField = false;
                    config.showEnergy = false;
                    document.getElementById('hud').style.opacity = 0;
                }
            },
            {
                title: "Connecting the Source",
                text: "We connect a battery (voltage source) to the plates. The Battery Symbol: Look at the circuit diagram to the left. The long, thin line represents the Positive Terminal (+), and the short, thick line represents the Negative Terminal (-). <br><br>The battery acts like a charge pump.<br><br>It pulls electrons off the top plate (leaving it positive) and pushes them onto the bottom plate (making it negative).<br><br><strong>Try increasing the Voltage.</strong> Note that charges accumulate on the <em>inner surfaces</em> due to mutual attraction.",
                controls: `
                <div class="slider-container">
                    <div class="slider-label"><span>Voltage</span><span id="lbl-vol">0 V</span></div>
                    <input type="range" min="0" max="10" step="0.1" value="0" oninput="setVoltage(this.value)">
                </div>
            `,
                setup: () => {
                    config.showCircuit = true;
                    config.showField = false;
                    config.showEnergy = false;
                    document.getElementById('hud').style.opacity = 1;
                }
            },
            {
                title: "The Electric Field",
                text: "The separation of charge creates a Uniform Electric Field ($E$) between the plates, pointing from positive to negative.<br><br>The strength of this field is determined by the voltage and the distance: <div class='math-block'>$$ E = \\frac{V}{d} $$</div><br>Notice that inside the metal plates themselves, the field is zero.",
                controls: `
                <div class="slider-container">
                    <div class="slider-label"><span>Voltage</span><span id="lbl-vol">5.0 V</span></div>
                    <input type="range" min="0" max="10" step="0.1" value="5.0" oninput="setVoltage(this.value)">
                </div>
                <button onclick="toggleField()">Toggle Field Lines</button>
            `,
                setup: () => {
                    config.voltage = 5;
                    config.showCircuit = true;
                    config.showField = true;
                }
            },
            {
                title: "Variable Separation",
                text: "Capacitance ($C$) measures the ability to store charge for a given voltage. It depends purely on geometry.<br><div class='math-block'>$$ C = \\frac{\\epsilon_0 A}{d} $$</div><br><strong>Experiment:</strong> Decrease the distance $d$ while keeping Voltage constant.<br>1. Capacitance increases.<br>2. More charge $Q$ is pulled from the battery.<br>3. The Electric Field $E=V/d$ gets stronger.",
                controls: `
                <div class="slider-container">
                    <div class="slider-label"><span>Distance (d)</span><span id="lbl-dist">12.0 mm</span></div>
                    <input type="range" min="50" max="250" step="1" value="120" oninput="setDistance(this.value)">
                </div>
                <div class="slider-container">
                    <div class="slider-label"><span>Voltage (V)</span><span id="lbl-vol">5.0 V</span></div>
                    <input type="range" min="0" max="10" step="0.1" value="5.0" oninput="setVoltage(this.value)">
                </div>
            `,
                setup: () => {
                    config.showField = true;
                    config.voltage = 5;
                    config.distance = 120;
                }
            },
            {
                title: "Conclusion",
                text: "Where is the energy stored? It's not in the charges, but in the <strong>Space</strong> between them.<br><br>The energy density $u$ (Cyan Glow) is proportional to the square of the field strength: $$ u \\propto E^2 $$<br>Even in a vacuum, this field carries real energy. This is the principle behind how capacitors store power for camera flashes and defibrillators.",
                controls: `
                 <div class="slider-container">
                    <div class="slider-label"><span>Voltage (V)</span><span id="lbl-vol">5.0 V</span></div>
                    <input type="range" min="0" max="10" step="0.1" value="5.0" oninput="setVoltage(this.value)">
                </div>
                <div class="slider-container">
                    <div class="slider-label"><span>Distance (d)</span><span id="lbl-dist">12.0 mm</span></div>
                    <input type="range" min="50" max="250" step="1" value="120" oninput="setDistance(this.value)">
                </div>
            `,
                setup: () => {
                    config.showEnergy = true;
                    config.showField = true;
                    config.voltage = 6;
                    config.distance = 120;
                    document.getElementById('btn-next').innerText = "Next Lesson";
                    document.getElementById('btn-next').disabled = false;
                }
            }
        ];

        let currentStep = 0;

        function loadStep(idx) {
            currentStep = idx;
            const s = steps[idx];

            document.getElementById('story-container').innerHTML = `
            <div class="chapter-title">${s.title}</div>
            <div class="text-content">${s.text}</div>
        `;
            document.getElementById('dynamic-controls').innerHTML = s.controls;

            renderMathInElement(document.getElementById('story-container'), {
                delimiters: [{ left: "$$", right: "$$", display: true }]
            });

            s.setup();

            // Update labels
            if (document.getElementById('lbl-vol')) document.getElementById('lbl-vol').innerText = config.voltage + " V";
            if (document.getElementById('lbl-dist')) document.getElementById('lbl-dist').innerText = (config.distance / 10).toFixed(1) + " mm";

            const btn = document.getElementById('btn-next');
            if (currentStep === steps.length - 1) {
                btn.innerHTML = "Next Lesson";
                btn.disabled = false;
            } else {
                btn.innerHTML = "Next";
                btn.disabled = false;
            }
        }

        // --- INTERACTION ---
        window.setVoltage = (v) => {
            config.voltage = parseFloat(v);
            const lbl = document.getElementById('lbl-vol');
            if (lbl) lbl.innerText = config.voltage.toFixed(1) + " V";
        };

        window.setDistance = (d) => {
            config.distance = parseFloat(d);
            const lbl = document.getElementById('lbl-dist');
            if (lbl) lbl.innerText = (config.distance / 10).toFixed(1) + " mm";
        };

        window.toggleField = () => {
            config.showField = !config.showField;
        };

        function nextStep() {
            if (currentStep < steps.length - 1) {
                loadStep(currentStep + 1);
            } else {
                window.top.location.href = '/theapplefalls/lesson/6_energy_in_cap';
            }
        }

        function prevStep() { if (currentStep > 0) loadStep(currentStep - 1); }

        loadStep(0);

    </script>
</body>

</html>