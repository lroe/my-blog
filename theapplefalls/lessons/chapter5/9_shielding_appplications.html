<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Shielding Applications</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <style>
        /* --- THEME SETTINGS (ORANGE ACCENT) --- */
        :root {
            --bg: #151515;
            --panel: #1e1e1e;
            --text: #dcdcdc;

            /* Updated to Orange to match Chapter 5 */
            --accent: #ff9f43;
            --accent-hover: #e58e3c;

            --danger: #ff7675;
            --good: #55efc4;
            --border: #333;
        }

        body {
            margin: 0;
            height: 100vh;
            display: flex;
            background: var(--bg);
            color: var(--text);
            font-family: 'Segoe UI', sans-serif;
            overflow: hidden;
        }

        /* --- SIDEBAR --- */
        aside {
            width: 420px;
            background: var(--panel);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            box-shadow: 10px 0 30px rgba(0, 0, 0, 0.5);
            z-index: 10;
        }

        header {
            padding: 20px;
            border-bottom: 1px solid var(--border);
            background: rgba(0, 0, 0, 0.2);
        }

        h1 {
            margin: 0;
            font-size: 20px;
            color: var(--accent);
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .subtitle {
            font-size: 12px;
            color: #777;
            margin-top: 5px;
            font-style: italic;
        }

        /* --- STORY & CONTENT --- */
        #story-container {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .scenario-tag {
            display: inline-block;
            background: #333;
            color: #fff;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 10px;
            text-transform: uppercase;
            margin-bottom: 10px;
            border: 1px solid #555;
        }

        .chapter-title {
            font-size: 22px;
            font-weight: 300;
            color: #fff;
            margin-bottom: 15px;
            border-left: 4px solid var(--accent);
            padding-left: 15px;
        }

        .story-text {
            line-height: 1.7;
            font-size: 14px;
            color: #ccc;
            margin-bottom: 20px;
        }

        .story-text strong {
            color: #fff;
        }

        /* --- CONTROLS --- */
        #controls-area {
            background: #181818;
            padding: 20px;
            border-top: 1px solid var(--border);
        }

        button {
            background: #333;
            color: #aaa;
            border: 1px solid #444;
            padding: 12px 15px;
            cursor: pointer;
            border-radius: 4px;
            font-size: 13px;
            transition: all 0.2s;
            width: 100%;
            text-transform: uppercase;
            font-weight: bold;
            margin-bottom: 10px;
        }

        button:hover {
            background: #444;
            color: #fff;
        }

        button.action-btn {
            background: #2d3436;
            border-color: var(--accent);
            color: var(--accent);
        }

        button.action-btn:hover {
            background: var(--accent);
            color: #111;
        }

        button.disabled {
            opacity: 0.5;
            cursor: not-allowed;
            pointer-events: none;
            filter: grayscale(1);
        }

        /* --- NAVIGATION --- */
        #nav-footer {
            padding: 20px;
            display: flex;
            justify-content: space-between;
            border-top: 1px solid var(--border);
            background: #222;
        }

        .nav-btn {
            width: 48%;
            border: none;
            background: #333;
            color: white;
        }

        .nav-btn.next {
            background: var(--accent);
            color: #111;
        }

        .nav-btn.next:hover {
            background: var(--accent-hover);
        }

        /* --- MAIN VIEWPORT --- */
        main {
            flex: 1;
            position: relative;
            background: radial-gradient(circle at center, #2d3436 0%, #000000 100%);
            overflow: hidden;
        }

        /* --- HUD ELEMENTS --- */
        .hud-panel {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            border: 1px solid #444;
            padding: 15px;
            border-radius: 8px;
            color: #fff;
            font-family: monospace;
            width: 200px;
            pointer-events: none;
        }

        .status-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 12px;
        }

        .status-val {
            font-weight: bold;
        }

        .val-danger {
            color: var(--danger);
        }

        .val-safe {
            color: var(--good);
        }

        #scope-canvas {
            width: 100%;
            height: 60px;
            background: #111;
            border: 1px solid #333;
            margin-top: 5px;
        }
    </style>
</head>

<body>
    <aside>
        <header>
            <h1>Maxwell's Notebook</h1>
            <div class="subtitle">Chapter 5: Real-World Applications</div>
        </header>

        <div id="story-container">
            <div id="chapter-content"></div>
        </div>

        <div id="controls-area">
            <div id="dynamic-controls"></div>
        </div>

        <div id="nav-footer">
            <button class="nav-btn" onclick="prevScenario()">Previous</button>
            <button class="nav-btn next" id="btn-next" onclick="nextScenario()">Next Scenario &rarr;</button>
        </div>
    </aside>

    <main id="world">
        <div id="hud" class="hud-panel" style="display:none;">
            <div style="border-bottom:1px solid #444; margin-bottom:10px; padding-bottom:5px; color:#888;">SENSOR
                READINGS</div>
            <div id="hud-content"></div>
        </div>
    </main>

    <script>
        // --- 1. THREE.JS BOILERPLATE ---
        const scene = new THREE.Scene();
        const sidebarWidth = 420;
        let aspect = (window.innerWidth - sidebarWidth) / window.innerHeight;

        const camera = new THREE.PerspectiveCamera(45, aspect, 0.1, 1000);
        camera.position.set(30, 20, 30);
        camera.lookAt(0, 5, 0);

        const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setSize(window.innerWidth - sidebarWidth, window.innerHeight);
        document.getElementById('world').appendChild(renderer.domElement);

        const controls = new THREE.OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        controls.dampingFactor = 0.05;

        // Lighting
        const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
        scene.add(ambientLight);
        const dirLight = new THREE.DirectionalLight(0xffffff, 0.8);
        dirLight.position.set(10, 20, 10);
        scene.add(dirLight);
        const pointLight = new THREE.PointLight(0xff9f43, 0.5); // Orange glow for atmosphere
        pointLight.position.set(0, 10, 0);
        scene.add(pointLight);

        // --- 2. SCENARIO OBJECTS ---

        const groupCar = new THREE.Group();
        const groupCable = new THREE.Group();
        const groupMRI = new THREE.Group();
        scene.add(groupCar);
        scene.add(groupCable);
        scene.add(groupMRI);

        groupCar.visible = false;
        groupCable.visible = false;
        groupMRI.visible = false;

        // === SCENARIO 1: THE CAR ===
        const carMat = new THREE.MeshStandardMaterial({ color: 0x555555, roughness: 0.2, metalness: 0.8 });
        const carBody = new THREE.Mesh(new THREE.BoxGeometry(10, 3, 18), carMat);
        carBody.position.y = 3;
        const carTop = new THREE.Mesh(new THREE.BoxGeometry(9, 2.5, 10), carMat);
        carTop.position.y = 5.5;

        // Wheels
        const wheelGeo = new THREE.CylinderGeometry(1.5, 1.5, 1, 16);
        const wheelMat = new THREE.MeshStandardMaterial({ color: 0x111111 });
        [[-4, 1.5, 6], [4, 1.5, 6], [-4, 1.5, -6], [4, 1.5, -6]].forEach(pos => {
            const w = new THREE.Mesh(wheelGeo, wheelMat);
            w.rotation.z = Math.PI / 2;
            w.position.set(...pos);
            groupCar.add(w);
        });
        groupCar.add(carBody, carTop);

        const ground = new THREE.Mesh(new THREE.CircleGeometry(25, 32), new THREE.MeshStandardMaterial({ color: 0x222222, roughness: 1 }));
        ground.rotation.x = -Math.PI / 2;
        groupCar.add(ground);

        // Lightning Vars
        const lightningMaterial = new THREE.LineBasicMaterial({ color: 0xffffff, linewidth: 3 });
        let lightningLine = null;

        // === SCENARIO 2: COAXIAL CABLE ===
        const cableLength = 20;

        // Inner Conductor
        const innerGeo = new THREE.CylinderGeometry(0.5, 0.5, cableLength, 16);
        const innerMat = new THREE.MeshStandardMaterial({ color: 0xff6b6b });
        const innerWire = new THREE.Mesh(innerGeo, innerMat);
        innerWire.rotation.z = Math.PI / 2;
        groupCable.add(innerWire);

        // Insulator
        const dielecGeo = new THREE.CylinderGeometry(2, 2, cableLength, 16, 1, true);
        const dielecMat = new THREE.MeshStandardMaterial({ color: 0xffffff, transparent: true, opacity: 0.2, side: THREE.DoubleSide });
        const dielectric = new THREE.Mesh(dielecGeo, dielecMat);
        dielectric.rotation.z = Math.PI / 2;
        groupCable.add(dielectric);

        // Shield
        const shieldGeo = new THREE.CylinderGeometry(2.1, 2.1, cableLength, 16, 1, true);
        const shieldMat = new THREE.MeshStandardMaterial({
            color: 0xaaaaaa,
            side: THREE.DoubleSide,
            wireframe: true,
            transparent: true,
            opacity: 0.1
        });
        const cableShield = new THREE.Mesh(shieldGeo, shieldMat);
        cableShield.rotation.z = Math.PI / 2;
        groupCable.add(cableShield);

        const noiseParticles = new THREE.Group();
        groupCable.add(noiseParticles);

        // === SCENARIO 3: MRI ROOM (Detailed) ===

        // 1. The Copper Room (Cage)
        // Using a copper color to signify the shielding
        const roomGeo = new THREE.BoxGeometry(16, 12, 16);
        const roomMat = new THREE.MeshBasicMaterial({ color: 0xb87333, wireframe: true }); // Copper
        const mriRoom = new THREE.Mesh(roomGeo, roomMat);
        mriRoom.position.y = 6;
        groupMRI.add(mriRoom);

        // 2. The Scanner Construction
        const scannerGroup = new THREE.Group();
        groupMRI.add(scannerGroup);
        scannerGroup.position.set(0, 4.5, 0);

        // Main Bore (White Plastic)
        const boreMat = new THREE.MeshStandardMaterial({ color: 0xffffff, roughness: 0.3, metalness: 0.1 });
        const boreOuter = new THREE.Mesh(new THREE.CylinderGeometry(3.5, 3.5, 5, 32, 1, true), boreMat);
        const boreInner = new THREE.Mesh(new THREE.CylinderGeometry(2.0, 2.0, 5, 32, 1, true), new THREE.MeshStandardMaterial({ color: 0xeeeeee, side: THREE.DoubleSide }));
        boreOuter.rotation.z = Math.PI / 2;
        boreInner.rotation.z = Math.PI / 2;
        scannerGroup.add(boreOuter, boreInner);

        // Front Face (Donut Ring)
        const ringGeo = new THREE.RingGeometry(2.0, 3.5, 32);
        const frontFace = new THREE.Mesh(ringGeo, boreMat);
        frontFace.rotation.y = Math.PI / 2;
        frontFace.position.x = 2.5;
        const backFace = frontFace.clone();
        backFace.position.x = -2.5;
        backFace.rotation.y = -Math.PI / 2;
        scannerGroup.add(frontFace, backFace);

        // Support Base
        const baseGeo = new THREE.BoxGeometry(4, 3, 4);
        const base = new THREE.Mesh(baseGeo, new THREE.MeshStandardMaterial({ color: 0xdddddd }));
        base.position.y = -2.5;
        scannerGroup.add(base);

        // Patient Table (Sliding out)
        const tableGeo = new THREE.BoxGeometry(8, 0.2, 1.8);
        const table = new THREE.Mesh(tableGeo, new THREE.MeshStandardMaterial({ color: 0x333333 }));
        table.position.set(3, -0.5, 0);
        scannerGroup.add(table);

        // Control Window (Glass in the copper wall)
        const winGeo = new THREE.PlaneGeometry(6, 4);
        const winMat = new THREE.MeshBasicMaterial({ color: 0x88ccff, transparent: true, opacity: 0.2, side: THREE.DoubleSide });
        const windowPane = new THREE.Mesh(winGeo, winMat);
        windowPane.position.set(0, 6, -8); // On back wall
        groupMRI.add(windowPane);

        // 3. The Door (Shield)
        const doorGeo = new THREE.PlaneGeometry(6, 10);
        const doorMat = new THREE.MeshStandardMaterial({ color: 0xb87333, transparent: true, opacity: 0.3, side: THREE.DoubleSide });
        const door = new THREE.Mesh(doorGeo, doorMat);
        door.position.set(0, 6, 8); // Front wall
        groupMRI.add(door);

        const waveGroup = new THREE.Group();
        groupMRI.add(waveGroup);


        // --- 3. ANIMATION STATE ---
        const appState = {
            scenario: 0,
            flashIntensity: 0,
            lightningActive: false,
            shieldEnabled: false,
            signalTime: 0,
            doorClosed: false
        };

        // --- 4. ANIMATION LOOP ---
        function animate() {
            requestAnimationFrame(animate);
            controls.update();

            // Car Flash
            if (appState.flashIntensity > 0) {
                appState.flashIntensity -= 0.05;
                carMat.emissive.setScalar(appState.flashIntensity * 0.5);
            }

            // Cable Noise
            if (groupCable.visible) {
                appState.signalTime += 0.2;
                renderOscilloscope();
                animateNoiseParticles();
            }

            // MRI Waves
            if (groupMRI.visible) {
                animateMRIWaves();
            }

            renderer.render(scene, camera);
        }

        function animateNoiseParticles() {
            if (Math.random() > 0.8) {
                const p = new THREE.Mesh(new THREE.SphereGeometry(0.2), new THREE.MeshBasicMaterial({ color: 0xffff00 }));
                const angle = Math.random() * Math.PI * 2;
                p.position.set((Math.random() - 0.5) * 20, Math.sin(angle) * 6, Math.cos(angle) * 6);
                p.userData = { vel: new THREE.Vector3(0, -Math.sin(angle) * 0.2, -Math.cos(angle) * 0.2) };
                noiseParticles.add(p);
            }

            for (let i = noiseParticles.children.length - 1; i >= 0; i--) {
                const p = noiseParticles.children[i];
                p.position.add(p.userData.vel);
                const dist = Math.sqrt(p.position.y ** 2 + p.position.z ** 2);

                if (appState.shieldEnabled && dist < 2.2) {
                    p.material.color.setHex(0xaaaaaa);
                    p.scale.multiplyScalar(0.8);
                    if (p.scale.x < 0.1) noiseParticles.remove(p);
                }
                else if (!appState.shieldEnabled && dist < 0.6) {
                    noiseParticles.remove(p);
                    appState.signalTime += Math.random() * 5;
                }
            }
        }

        function animateMRIWaves() {
            // Generate expanding rings outside
            if (Math.random() > 0.9) {
                const ring = new THREE.Mesh(
                    new THREE.RingGeometry(1, 1.2, 32),
                    new THREE.MeshBasicMaterial({ color: 0xff9f43, transparent: true, opacity: 0.8, side: THREE.DoubleSide })
                );
                ring.position.set((Math.random() - 0.5) * 40, (Math.random()) * 20, (Math.random() - 0.5) * 40);
                ring.lookAt(0, 6, 0);
                if (ring.position.distanceTo(new THREE.Vector3(0, 6, 0)) > 10) {
                    waveGroup.add(ring);
                }
            }

            for (let i = waveGroup.children.length - 1; i >= 0; i--) {
                const r = waveGroup.children[i];
                const center = new THREE.Vector3(0, 6, 0);
                const dir = new THREE.Vector3().subVectors(center, r.position).normalize();
                r.position.add(dir.multiplyScalar(0.2));
                const dist = r.position.distanceTo(center);

                // Hit Room Walls (approx radius 8)
                if (dist < 8) {
                    if (appState.doorClosed) {
                        r.material.opacity -= 0.1;
                        if (r.material.opacity <= 0) waveGroup.remove(r);
                    } else {
                        if (dist < 2) waveGroup.remove(r);
                    }
                }
            }
        }

        // --- 5. INTERACTION LOGIC ---

        function strikeLightning() {
            if (appState.lightningActive) return;
            appState.lightningActive = true;
            appState.flashIntensity = 1.0;

            const points = [];
            points.push(new THREE.Vector3(0, 30, 0));
            let curr = new THREE.Vector3(0, 30, 0);
            for (let i = 0; i < 10; i++) {
                curr.y -= 2.5;
                curr.x += (Math.random() - 0.5) * 2;
                curr.z += (Math.random() - 0.5) * 2;
                points.push(curr.clone());
            }
            points.push(new THREE.Vector3(0, 5.5, 0));

            const groundPath1 = [new THREE.Vector3(0, 5.5, 0), new THREE.Vector3(5, 3, 0), new THREE.Vector3(5, 0, 0)];
            const groundPath2 = [new THREE.Vector3(0, 5.5, 0), new THREE.Vector3(-5, 3, 0), new THREE.Vector3(-5, 0, 0)];

            if (lightningLine) scene.remove(lightningLine);
            const geo = new THREE.BufferGeometry().setFromPoints(points);
            lightningLine = new THREE.Line(geo, lightningMaterial);
            scene.add(lightningLine);

            const arcMat = new THREE.LineBasicMaterial({ color: 0x00ffff });
            const arc1 = new THREE.Line(new THREE.BufferGeometry().setFromPoints(groundPath1), arcMat);
            const arc2 = new THREE.Line(new THREE.BufferGeometry().setFromPoints(groundPath2), arcMat);
            scene.add(arc1, arc2);

            updateHUD("Car", "STRIKE DETECTED", "Surface Flow", "0 V/m");

            setTimeout(() => {
                scene.remove(lightningLine);
                scene.remove(arc1);
                scene.remove(arc2);
                appState.lightningActive = false;
                document.getElementById('btn-next').disabled = false;
            }, 500);
        }

        function toggleCableShield() {
            appState.shieldEnabled = !appState.shieldEnabled;
            const btn = document.getElementById('btn-shield');

            if (appState.shieldEnabled) {
                cableShield.material.opacity = 0.8;
                cableShield.material.wireframe = false;
                cableShield.material.color.setHex(0xefefef);
                btn.innerText = "Deactivate Braided Shield";
                btn.classList.remove('action-btn');
                updateHUD("Cable", "Shield ACTIVE", "Clean Signal", "Protected");
            } else {
                cableShield.material.opacity = 0.1;
                cableShield.material.wireframe = true;
                cableShield.material.color.setHex(0xaaaaaa);
                btn.innerText = "Activate Braided Shield";
                btn.classList.add('action-btn');
                updateHUD("Cable", "Shield OFF", "High Noise", "Vulnerable");
            }
            document.getElementById('btn-next').disabled = false;
        }

        function toggleMRIDoor() {
            appState.doorClosed = !appState.doorClosed;
            const btn = document.getElementById('btn-door');

            if (appState.doorClosed) {
                door.material.opacity = 0.9;
                door.material.color.setHex(0xb87333);
                btn.innerText = "Open RF Door";
                updateHUD("MRI", "Cage SEALED", "Scan Quality: 100%", "Quiet");
            } else {
                door.material.opacity = 0.1;
                btn.innerText = "Close RF Door";
                updateHUD("MRI", "Door OPEN", "Scan Quality: 15%", "Noisy");
            }
            document.getElementById('btn-next').disabled = false;
        }

        // --- 6. 2D CANVAS RENDERING ---
        function renderOscilloscope() {
            const canvas = document.getElementById('scope-canvas');
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            const w = canvas.width;
            const h = canvas.height;

            ctx.fillStyle = '#111';
            ctx.fillRect(0, 0, w, h);
            ctx.beginPath();
            ctx.strokeStyle = '#ff6b6b';
            ctx.lineWidth = 2;

            const t = appState.signalTime;
            for (let x = 0; x < w; x++) {
                let y = Math.sin((x + t * 10) * 0.05) * (h / 3);
                if (!appState.shieldEnabled) {
                    y += (Math.random() - 0.5) * (h / 1.5);
                }
                ctx.lineTo(x, h / 2 + y);
            }
            ctx.stroke();
        }

        function updateHUD(mode, status, detail, field) {
            const hud = document.getElementById('hud');
            hud.style.display = 'block';
            const content = document.getElementById('hud-content');

            let colorClass = status.includes("OFF") || status.includes("OPEN") ? "val-danger" : "val-safe";
            if (mode === "Car") colorClass = "val-safe";

            content.innerHTML = `
                <div class="status-row"><span>System:</span> <span class="status-val">${mode}</span></div>
                <div class="status-row"><span>Status:</span> <span class="status-val ${colorClass}">${status}</span></div>
                <div class="status-row"><span>Detail:</span> <span class="status-val">${detail}</span></div>
                <div class="status-row"><span>Interior Field:</span> <span class="status-val">${field}</span></div>
            `;

            if (mode === "Cable") {
                content.innerHTML += `<canvas id="scope-canvas" width="170" height="60"></canvas>`;
            }
        }

        // --- 7. STORY ENGINE ---

        const scenarios = [
            {
                id: 0,
                group: groupCar,
                title: "Faraday Cage on Wheels",
                tag: "Electrostatics",
                text: "Does a car's rubber tires protect you from lightning? <strong>No.</strong><br><br>The car is a metal shellâ€”a Faraday Cage. If lightning strikes, the massive charge flows along the <em>outer skin</em> of the metal body and jumps to the ground.<br><br>The electric field inside the car remains zero. You are safe because of the metal body, not the rubber tires.",
                controls: `<button class="action-btn" onclick="strikeLightning()">Strike Lightning</button>`,
                init: () => {
                    camera.position.set(20, 10, 20);
                    updateHUD("Car", "Standby", "Neutral", "0 V/m");
                    document.getElementById('btn-next').disabled = true;
                }
            },
            {
                id: 1,
                group: groupCable,
                title: "Shielding Electronics",
                tag: "Signal Integrity",
                text: "This is a <strong>Coaxial Cable</strong> carrying delicate data (red wire).<br><br>Electronic 'noise' (yellow particles) from power lines and wifi surrounds us. Without a shield, this noise corrupts the signal (watch the graph glitch).<br><br>The outer braided mesh acts as a flexible Faraday cage, catching the noise and grounding it before it reaches the core.",
                controls: `<button id="btn-shield" class="action-btn" onclick="toggleCableShield()">Activate Braided Shield</button>`,
                init: () => {
                    camera.position.set(15, 15, 0);
                    camera.lookAt(0, 0, 0);
                    appState.shieldEnabled = false;
                    cableShield.material.opacity = 0.1;
                    cableShield.material.wireframe = true;
                    updateHUD("Cable", "Shield OFF", "Noisy", "High");
                    document.getElementById('btn-next').disabled = true;
                }
            },
            {
                id: 2,
                group: groupMRI,
                title: "Conclusion",
                tag: "RF Shielding",
                text: "An MRI machine (white cylinder) detects faint radio signals from your body. <br><br>The surrounding room is lined with a <strong>Copper Mesh</strong> (Faraday Cage) to block external 'RF Smog' (orange waves).<br><br>If the door is open, the cage is incomplete, and external noise ruins the scan.",
                controls: `<button id="btn-door" class="action-btn" onclick="toggleMRIDoor()">Close RF Door</button>`,
                init: () => {
                    camera.position.set(0, 15, 30);
                    camera.lookAt(0, 5, 0);
                    appState.doorClosed = false;
                    door.material.opacity = 0.1;
                    updateHUD("MRI", "Door OPEN", "Interference", "High");
                    document.getElementById('btn-next').innerText = "Next Lesson";
                    document.getElementById('btn-next').disabled = true;
                }
            }
        ];

        function loadScenario(index) {
            appState.scenario = index;
            const s = scenarios[index];

            groupCar.visible = (index === 0);
            groupCable.visible = (index === 1);
            groupMRI.visible = (index === 2);

            document.querySelector('header .subtitle').innerText = `Lesson 9: ${s.title}`;
            document.getElementById('chapter-content').innerHTML = `
                <div class="scenario-tag" style="border-color:var(--accent); color:var(--accent);">${s.tag}</div>
                <div class="chapter-title">${s.title}</div>
                <div class="story-text">${s.text}</div>
            `;
            document.getElementById('dynamic-controls').innerHTML = s.controls;

            const btn = document.getElementById('btn-next');
            if (appState.scenario === scenarios.length - 1) {
                btn.innerHTML = "Next Lesson";
            } else {
                btn.innerHTML = "Next Scenario &rarr;";
            }

            s.init();
        }

        function nextScenario() {
            if (appState.scenario < scenarios.length - 1) {
                loadScenario(appState.scenario + 1);
            } else {
                window.parent.location.href = '/lesson/chapter5/non_spherical';
            }
        }

        function prevScenario() {
            if (appState.scenario > 0) {
                loadScenario(appState.scenario - 1);
            }
        }

        animate();
        loadScenario(0);

        window.addEventListener('resize', () => {
            aspect = (window.innerWidth - sidebarWidth) / window.innerHeight;
            camera.aspect = aspect;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth - sidebarWidth, window.innerHeight);
        });

    </script>
</body>

</html>