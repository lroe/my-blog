<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Insulators & Polarization: The Subtle Shift</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        /* --- THEME & LAYOUT --- */
        :root {
            --bg: #151515;
            --panel: #1e1e1e;
            --text: #dcdcdc;
            --accent: #ff9f43;
            /* Orange */
            --accent-hover: #e58e3c;
            --border: #333;
            --electron: #00d2d3;
            /* Cyan */
            --proton: #ff6b6b;
            /* Red */
        }

        body {
            margin: 0;
            height: 100vh;
            display: flex;
            background: var(--bg);
            color: var(--text);
            font-family: 'Segoe UI', sans-serif;
            overflow: hidden;
        }

        /* LEFT PANEL */
        aside {
            width: 420px;
            background: var(--panel);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            box-shadow: 10px 0 30px rgba(0, 0, 0, 0.5);
            z-index: 10;
        }

        header {
            padding: 20px;
            border-bottom: 1px solid var(--border);
            background: rgba(0, 0, 0, 0.2);
        }

        h1 {
            margin: 0;
            font-size: 20px;
            color: var(--accent);
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .subtitle {
            font-size: 12px;
            color: #777;
            margin-top: 5px;
            font-style: italic;
        }

        #story-container {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .chapter-title {
            font-size: 24px;
            font-weight: 300;
            color: #fff;
            margin-bottom: 20px;
            border-left: 4px solid var(--accent);
            padding-left: 15px;
        }

        .story-text {
            line-height: 1.8;
            font-size: 15px;
            color: #ccc;
            margin-bottom: 20px;
        }

        .story-text strong {
            color: #fff;
            font-weight: 600;
        }

        .instruction-inline {
            color: var(--accent);
            font-weight: bold;
        }

        /* CONTROLS AREA */
        #controls-area {
            background: #181818;
            padding: 20px;
            border-top: 1px solid var(--border);
        }

        .control-row {
            margin-bottom: 15px;
            opacity: 0.5;
            transition: 0.3s;
            filter: grayscale(1);
            position: relative;
        }

        .control-row.active {
            opacity: 1;
            filter: grayscale(0);
        }

        label {
            display: block;
            font-size: 11px;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
        }

        button {
            background: #333;
            color: #aaa;
            border: 1px solid #444;
            padding: 10px 15px;
            cursor: pointer;
            border-radius: 4px;
            font-size: 13px;
            transition: all 0.2s;
            width: 100%;
            text-transform: uppercase;
            font-weight: bold;
        }

        button:hover:not(:disabled) {
            background: #444;
            color: #fff;
        }

        button:disabled {
            cursor: not-allowed;
        }

        input[type=range] {
            width: 100%;
            accent-color: var(--accent);
            cursor: pointer;
        }

        input[type=range]:disabled {
            cursor: not-allowed;
            opacity: 0.5;
        }

        /* TOGGLE SWITCH for MICRO VIEW */
        .toggle-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-top: 10px;
        }

        .toggle-label {
            font-size: 13px;
            color: #fff;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 40px;
            height: 20px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #333;
            transition: .4s;
            border-radius: 20px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 14px;
            width: 14px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked+.slider {
            background-color: var(--accent);
        }

        input:checked+.slider:before {
            transform: translateX(20px);
        }

        /* NAVIGATION FOOTER */
        #nav-footer {
            padding: 20px;
            display: flex;
            justify-content: space-between;
            border-top: 1px solid var(--border);
            background: #222;
        }

        .nav-btn {
            width: 48%;
            background: #333;
            color: #fff;
            border: none;
        }

        .nav-btn.next {
            background: var(--accent);
            color: #151515;
        }

        .nav-btn.next:hover:not(:disabled) {
            background: var(--accent-hover);
            color: #000;
        }

        .nav-btn.next:disabled {
            background: #333;
            color: #555;
            cursor: not-allowed;
            opacity: 0.5;
        }

        main {
            flex: 1;
            position: relative;
            background: #151515;
            overflow: hidden;
        }

        #legend {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.6);
            padding: 15px;
            border-radius: 8px;
            pointer-events: none;
            border: 1px solid #333;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            font-size: 12px;
            color: #ccc;
        }

        .dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 10px;
        }
    </style>
</head>

<body>

    <aside>
        <header>
            <h1>Franklin's Lab</h1>
            <div class="subtitle">Module: Insulators & Polarization</div>
        </header>

        <div id="story-container">
            <div id="chapter-content">
                <!-- Content injected by JS -->
            </div>
        </div>

        <div id="controls-area">
            <!-- 1. Bring Rod -->
            <div class="control-row" id="ctrl-rod">
                <label>1. Tools</label>
                <button id="btn-rod" disabled onclick="toggleRod()">Equip Negative Rod</button>
            </div>

            <!-- 2. Slider -->
            <div class="control-row" id="ctrl-move">
                <label>2. Distance</label>
                <input type="range" id="slider-dist" disabled min="0" max="100" value="0" step="1">
            </div>

            <!-- 3. Micro View Toggle -->
            <div class="control-row active" style="border-top: 1px solid #333; padding-top: 10px; margin-top: 10px;">
                <div class="toggle-container">
                    <span class="toggle-label">Microscopic View (X-Ray)</span>
                    <label class="switch">
                        <input type="checkbox" id="check-micro" checked onchange="toggleMicroView()">
                        <span class="slider"></span>
                    </label>
                </div>
            </div>

            <div class="control-row active" style="margin-top:10px;">
                <button onclick="resetSim()" style="background: transparent; border: 1px solid #555; color: #777;">Reset
                    Experiment</button>
            </div>
        </div>

        <div id="nav-footer">
            <button class="nav-btn" onclick="prevLesson()">Back</button>
            <button class="nav-btn next" id="btn-next" onclick="nextLesson()">Next &rarr;</button>
        </div>
    </aside>

    <main id="world">
        <div id="legend">
            <div style="font-size: 10px; text-transform: uppercase; color: #666; margin-bottom: 5px;">Legend</div>
            <div class="legend-item">
                <div class="dot" style="background: #ff6b6b;"></div>Pos. Nucleus (Fixed)
            </div>
            <div class="legend-item">
                <div class="dot" style="background: #00d2d3; box-shadow: 0 0 5px #00d2d3;"></div>Neg. Electron Cloud
            </div>
        </div>
    </main>

    <script>
        // ==========================================
        // PART 1: THE 3D ENGINE
        // ==========================================

        const state = {
            rodVisible: false,
            rodPosPercent: 0,
            microView: true,
            molecules: [] // Stores reference to our atom objects
        };

        const scene = new THREE.Scene();
        // --- 1. THE VOID (BACKGROUND) ---
        scene.background = new THREE.Color(0x151515);

        // Camera Setup
        const sidebarWidth = 420;
        let aspect = (window.innerWidth - sidebarWidth) / window.innerHeight;
        const viewSize = 28;
        const camera = new THREE.OrthographicCamera(
            -viewSize * aspect / 2, viewSize * aspect / 2,
            viewSize / 2, -viewSize / 2,
            1, 1000
        );
        camera.position.set(20, 20, 20);
        camera.lookAt(0, 0, 0);

        // Renderer
        const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setSize(window.innerWidth - sidebarWidth, window.innerHeight);
        renderer.shadowMap.enabled = true; // Shadows enabled
        renderer.shadowMap.type = THREE.PCFSoftShadowMap;
        document.getElementById('world').appendChild(renderer.domElement);

        // --- 2. LIGHTING SETUP ---
        // A. Ambient Light (The Fill)
        const ambientLight = new THREE.AmbientLight(0xffffff, 0.6); // 60% intensity
        scene.add(ambientLight);

        // B. Directional Light (The Key Light)
        const dirLight = new THREE.DirectionalLight(0xffffff, 0.8); // 80% intensity
        dirLight.position.set(10, 20, 5); // Position: Top-Right-Front
        dirLight.castShadow = true;
        // Shadow quality settings
        dirLight.shadow.mapSize.width = 2048;
        dirLight.shadow.mapSize.height = 2048;
        dirLight.shadow.camera.near = 0.5;
        dirLight.shadow.camera.far = 100;
        // Expand shadow camera for Orthographic scenes to cover the floor
        dirLight.shadow.camera.left = -50;
        dirLight.shadow.camera.right = 50;
        dirLight.shadow.camera.top = 50;
        dirLight.shadow.camera.bottom = -50;
        scene.add(dirLight);

        // --- 3. THE FLOOR ---
        const floorGeo = new THREE.PlaneGeometry(100, 100);
        const floorMat = new THREE.MeshStandardMaterial({
            color: 0x222222,
            roughness: 1.0,
            metalness: 0.0
        });
        const floor = new THREE.Mesh(floorGeo, floorMat);
        floor.rotation.x = -Math.PI / 2;
        floor.position.y = -10; // Placed below the objects
        floor.receiveShadow = true;
        scene.add(floor);

        // --- THE INSULATOR BLOCK ---
        const blockGroup = new THREE.Group();
        scene.add(blockGroup);

        // The physical block (Macro view)
        const blockGeo = new THREE.BoxGeometry(10, 8, 10);
        const blockMat = new THREE.MeshPhongMaterial({
            color: 0x444444,
            transparent: true,
            opacity: 0.1,
            shininess: 80,
            side: THREE.DoubleSide,
            depthWrite: false
        });
        const blockMesh = new THREE.Mesh(blockGeo, blockMat);
        blockMesh.renderOrder = 0;

        // --- MODIFICATION: Enable Box Shadow ---
        blockMesh.castShadow = true;

        blockGroup.add(blockMesh);

        // Wireframe edges
        const edges = new THREE.EdgesGeometry(blockGeo);
        const line = new THREE.LineSegments(edges, new THREE.LineBasicMaterial({ color: 0x555555 }));
        blockGroup.add(line);

        // --- THE MOLECULES (Micro View) ---
        const moleculeGroup = new THREE.Group();
        blockGroup.add(moleculeGroup);

        function createMolecule(x, y, z) {
            const group = new THREE.Group();
            group.position.set(x, y, z);

            // 1. The Nucleus (Positive)
            const nucGeo = new THREE.SphereGeometry(0.35, 16, 16);
            const nucMat = new THREE.MeshStandardMaterial({
                color: 0xff4444,     // Bright Red
                emissive: 0x660000,  // Glows slightly red
                roughness: 0.4
            });
            const nucleus = new THREE.Mesh(nucGeo, nucMat);

            // --- MODIFICATION: Disable Atom Shadow ---
            nucleus.castShadow = false;

            group.add(nucleus);

            // 2. The Electron Cloud (Negative)
            const cloudGeo = new THREE.SphereGeometry(0.75, 24, 24);
            const cloudMat = new THREE.MeshPhongMaterial({
                color: 0x66eeff,     // Light Blue (Cyan-ish)
                emissive: 0x002233,
                transparent: true,
                opacity: 0.3,
                depthWrite: false,
                side: THREE.DoubleSide
            });
            const cloud = new THREE.Mesh(cloudGeo, cloudMat);
            // Clouds are transparent, usually don't cast shadows
            group.add(cloud);

            return {
                group: group,
                nucleus: nucleus,
                cloud: cloud,
                basePos: new THREE.Vector3(x, y, z)
            };
        }

        // Generate grid of molecules
        for (let x = -3.5; x <= 3.5; x += 3.5) {
            for (let y = -2.5; y <= 2.5; y += 2.5) {
                for (let z = -3.5; z <= 3.5; z += 3.5) {
                    const mol = createMolecule(x, y, z);
                    moleculeGroup.add(mol.group);
                    state.molecules.push(mol);
                }
            }
        }

        // --- THE ROD ---
        const rodGroup = new THREE.Group();
        const rodGeo = new THREE.CylinderGeometry(0.8, 0.8, 12, 32);
        rodGeo.rotateZ(Math.PI / 2); // Lay flat
        const rodMat = new THREE.MeshStandardMaterial({ color: 0xff4444, roughness: 0.2 });
        const rodMesh = new THREE.Mesh(rodGeo, rodMat);
        rodMesh.castShadow = true; // Rod Shadow enabled
        rodGroup.add(rodMesh);

        // Add negative signs
        for (let i = -4; i <= 4; i += 2) {
            const canvas = document.createElement('canvas');
            canvas.width = 64; canvas.height = 64;
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = 'white';
            ctx.font = 'bold 60px Arial';
            ctx.fillText('-', 25, 50);
            const tex = new THREE.CanvasTexture(canvas);
            const sign = new THREE.Mesh(new THREE.PlaneGeometry(0.8, 0.8), new THREE.MeshBasicMaterial({ map: tex, transparent: true, side: THREE.DoubleSide }));
            sign.position.set(i, 0.9, 0);
            sign.rotation.x = -Math.PI / 2;
            rodGroup.add(sign);
        }
        rodGroup.position.set(-50, 0, 0);
        scene.add(rodGroup);

        // ==========================================
        // PART 2: PHYSICS LOOP
        // ==========================================

        function animate() {
            requestAnimationFrame(animate);

            // 1. Rod Movement
            const targetX = -30 + (state.rodPosPercent / 100) * 10;

            if (state.rodVisible) {
                rodGroup.visible = true;
                rodGroup.position.x += (targetX - rodGroup.position.x) * 0.1;
            } else {
                rodGroup.visible = false;
                rodGroup.position.x = -50;
            }

            const rodTipX = rodGroup.position.x + 6; // Tip location

            // 2. Molecular Polarization Logic
            state.molecules.forEach(mol => {
                const molWorldPos = mol.basePos.clone(); // Approx position
                const dist = molWorldPos.x - rodTipX; // Distance to rod

                if (state.rodVisible && dist > 0) {
                    // Strength falls off with distance squared
                    const force = 100 / (dist * dist + 10);
                    const maxShift = 0.6;
                    const shift = Math.min(force * 0.8, maxShift);

                    // Apply Shift - Cloud moves AWAY from negative rod (to the right)
                    mol.cloud.position.x = THREE.MathUtils.lerp(mol.cloud.position.x, shift, 0.1);

                } else {
                    // Reset - Cloud centers on nucleus
                    mol.cloud.position.x = THREE.MathUtils.lerp(mol.cloud.position.x, 0, 0.1);
                }
            });

            // 3. Macro Block Movement
            if (state.rodVisible) {
                if (state.rodPosPercent > 20) {
                    const pull = (state.rodPosPercent / 100) * 2.0;
                    blockGroup.position.x = THREE.MathUtils.lerp(blockGroup.position.x, -pull, 0.05);
                } else {
                    blockGroup.position.x = THREE.MathUtils.lerp(blockGroup.position.x, 0, 0.05);
                }
            } else {
                blockGroup.position.x = THREE.MathUtils.lerp(blockGroup.position.x, 0, 0.05);
            }

            moleculeGroup.visible = state.microView;
            renderer.render(scene, camera);
        }
        animate();

        // ==========================================
        // PART 3: INTERACTION & STORY
        // ==========================================

        function toggleRod() {
            state.rodVisible = true;
            document.getElementById('btn-rod').disabled = true;
            document.getElementById('btn-rod').innerText = "Rod Equipped";
            checkAdvance();
        }

        document.getElementById('slider-dist').addEventListener('input', (e) => {
            state.rodPosPercent = e.target.value;
            checkAdvance();
        });

        function toggleMicroView() {
            state.microView = document.getElementById('check-micro').checked;
        }

        function resetSim() {
            state.rodVisible = false;
            state.rodPosPercent = 0;
            document.getElementById('slider-dist').value = 0;
            document.getElementById('btn-rod').innerText = "Equip Negative Rod";
            blockGroup.position.x = 0;
            loadLesson(0);
        }

        // Helper to format the **text** into <strong>text</strong>
        function formatStoryText(text) {
            // Regex looks for ** ... ** and replaces with <strong> ... </strong>
            return text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
        }

        // STORY DATA
        let currentChapter = 0;
        const lessons = [
            {
                title: "1. The Insulator",
                text: "<strong>What is an Electron Cloud?</strong><br>In our previous Conductor experiment, we saw electrons as simple dots flowing freely.<br><br>Here in an **Insulator**, electrons are trapped. They orbit the nucleus so fast that they form a blurry **Cloud** (Cyan). They can wiggle, but they cannot leave the atom.",
                setup: () => {
                    state.microView = true;
                    document.getElementById('check-micro').checked = true;
                    toggleRodLogic(false);
                },
                check: () => true
            },
            {
                title: "2. Approaching Charge",
                text: "We have a <strong>Negatively Charged Rod</strong>. <br><br>Since the electrons in this block are trapped in clouds, they cannot flow to the other side like they did in metal. But they can still react.<br><br><span class='instruction-inline'>Equip the Rod</span> to begin.",
                setup: () => {
                    toggleRodLogic(true);
                },
                check: () => state.rodVisible
            },
            {
                title: "3. Polarization",
                text: "Watch the **Cyan Clouds** carefully. <br><span class='instruction-inline'>Drag the slider to 60%</span>.<br><br>The negative rod repels the electron clouds. The clouds stretch and shift to the <em>right</em>, away from the rod.<br><br>The **Red Nuclei** stay put, but now they are slightly 'exposed' on the left side.",
                setup: () => {
                    toggleSliderLogic(true);
                },
                check: () => state.rodPosPercent > 50
            },
            {
                title: "4. Conclusion & The Next Step",
                text: "The slight shift you see is **Polarization**. The positive nuclei are now closer to the rod than the repelled clouds, creating a net attraction that pulls the neutral block.<br><br>We know charges push and pull. But can we measure exactly *how hard* they push?<br><br>Next, we will visit Charles Coulomb's lab to quantify this force.",
                setup: () => { },
                check: () => state.rodPosPercent > 90
            }
        ];

        function toggleRodLogic(enable) {
            const row = document.getElementById('ctrl-rod');
            const btn = document.getElementById('btn-rod');
            if (enable) {
                row.classList.add('active');
                btn.disabled = false;
            } else {
                row.classList.remove('active');
                btn.disabled = true;
            }
        }

        function toggleSliderLogic(enable) {
            const row = document.getElementById('ctrl-move');
            const slide = document.getElementById('slider-dist');
            if (enable) {
                row.classList.add('active');
                slide.disabled = false;
            } else {
                row.classList.remove('active');
                slide.disabled = true;
            }
        }

        function loadLesson(idx) {
            currentChapter = idx;
            const l = lessons[idx];
            document.querySelector('header .subtitle').innerText = `Module 1: Chapter 1 - Step ${idx + 1} of ${lessons.length}`;

            // Use the formatter here
            document.getElementById('chapter-content').innerHTML =
                `<div class="chapter-title">${l.title}</div>
                 <div class="story-text">${formatStoryText(l.text)}</div>`;

            // Reset controls state for safety before applying specific lesson setup
            if (idx === 0) {
                toggleRodLogic(false);
                toggleSliderLogic(false);
            }

            const btn = document.getElementById('btn-next');
            if (currentChapter === lessons.length - 1) {
                btn.innerHTML = "Next Chapter &rarr;";
            } else {
                btn.innerHTML = "Next &rarr;";
            }

            l.setup();
            checkAdvance();
        }

        function nextLesson() {
            if (currentChapter < lessons.length - 1) {
                loadLesson(currentChapter + 1);
            } else {
                // Navigate to Coulomb via React route
                window.location.href = '/theapplefalls/lessons/chapter1/Chapter1_Final/coulombs_law.html';
            }
        }
        function prevLesson() {
            if (currentChapter > 0) loadLesson(currentChapter - 1);
        }
        function checkAdvance() {
            const btn = document.getElementById('btn-next');
            if (lessons[currentChapter].check()) {
                btn.disabled = false;
            } else {
                btn.disabled = true;
            }
        }

        // Init
        loadLesson(0);

        window.addEventListener('resize', () => {
            const newAspect = (window.innerWidth - sidebarWidth) / window.innerHeight;
            camera.left = -viewSize * newAspect / 2;
            camera.right = viewSize * newAspect / 2;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth - sidebarWidth, window.innerHeight);
        });

    </script>
</body>

</html>