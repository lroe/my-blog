<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Maxwell's Notebook: Isolated Capacitor</title>
    <!-- KaTeX CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <!-- KaTeX JS -->
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

    <style>
        :root {
            --bg: #151515;
            --panel: #1e1e1e;
            --text: #dcdcdc;
            --accent: #ff9f43;
            /* The Orange */
            --danger: #ff6b6b;
            --safe: #1dd1a1;
            --border: #333;
        }

        body {
            margin: 0;
            height: 100vh;
            display: flex;
            background: var(--bg);
            color: var(--text);
            font-family: 'Segoe UI', sans-serif;
            overflow: hidden;
        }

        /* Sidebar Styles */
        aside {
            width: 400px;
            background: var(--panel);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            z-index: 10;
            box-shadow: 10px 0 30px rgba(0, 0, 0, 0.5);
        }

        header {
            padding: 20px;
            border-bottom: 1px solid var(--border);
        }

        h1 {
            margin: 0;
            font-size: 18px;
            color: var(--accent);
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .subtitle {
            font-size: 12px;
            color: #888;
            margin-top: 5px;
        }

        /* Content Area */
        #story-container {
            flex: 1;
            padding: 25px;
            overflow-y: auto;
        }

        .chapter-title {
            font-size: 20px;
            color: #fff;
            margin-bottom: 15px;
            border-left: 3px solid var(--accent);
            padding-left: 10px;
        }

        .text-content {
            line-height: 1.6;
            font-size: 15px;
            color: #ccc;
            text-align: left;
            margin-bottom: 15px;
        }

        /* Math Block Styling */
        .math-block {
            background: #222;
            padding: 10px;
            border-radius: 6px;
            border: 1px solid #333;
            text-align: center;
            margin: 15px 0;
            color: var(--accent);
            font-size: 1.1em;
        }

        /* Controls */
        #controls {
            background: #111;
            padding: 20px;
            border-top: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        label {
            font-size: 12px;
            color: #888;
            text-transform: uppercase;
            font-weight: bold;
        }

        input[type=range] {
            width: 100%;
            cursor: pointer;
            accent-color: var(--accent);
        }

        /* Navigation */
        #nav {
            padding: 15px;
            display: flex;
            gap: 10px;
            background: #000;
            border-top: 1px solid var(--border);
        }

        .nav-btn {
            flex: 1;
            border: none;
            background: #2a2a2a;
            color: #fff;
            border: 1px solid #444;
            padding: 12px;
            font-weight: bold;
            transition: 0.2s;
            text-transform: uppercase;
            font-size: 12px;
            cursor: pointer;
            border-radius: 4px;
        }

        .nav-btn:hover {
            background: var(--accent);
            color: #111;
            border-color: var(--accent);
        }

        .next-btn {
            background: var(--accent);
            color: #111;
            border: none;
        }

        .disabled {
            opacity: 0.5;
            pointer-events: none;
        }

        /* Main Viewport */
        main {
            flex: 1;
            position: relative;
            background: radial-gradient(circle at center, #1a1a1a 0%, #080808 100%);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        canvas {
            box-shadow: 0 0 50px rgba(0, 0, 0, 0.5);
            border-radius: 4px;
        }

        /* Overlay for meters */
        .meter-overlay {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #444;
            width: 180px;
        }

        .meter-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-family: monospace;
            font-size: 14px;
        }

        .val {
            color: var(--accent);
        }

        .bar-container {
            width: 100%;
            height: 6px;
            background: #333;
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 15px;
        }

        .bar-fill {
            height: 100%;
            background: var(--accent);
            width: 50%;
            transition: width 0.1s;
        }
    </style>
</head>

<body>

    <aside>
        <header>
            <h1>Maxwell's Notebook</h1>
            <div class="subtitle">Chapter 7: The Isolated System (Q is Constant)</div>
        </header>
        <div id="story-container"></div>
        <div id="controls">
            <!-- Dynamic Controls injected via JS -->
        </div>
        <div id="nav">
            <button class="nav-btn" id="prevBtn" onclick="prevStep()">Back</button>
            <button class="nav-btn next-btn" id="nextBtn" onclick="nextStep()">Next</button>
        </div>
    </aside>

    <main id="viewport">
        <canvas id="simCanvas"></canvas>
        <div class="meter-overlay">
            <div class="meter-row"><span>Charge (Q):</span> <span class="val">CONSTANT</span></div>
            <div class="bar-container">
                <div class="bar-fill" style="width: 100%; background: #555;"></div>
            </div>

            <div class="meter-row"><span>Capacitance (C):</span> <span class="val" id="disp-c">Loading...</span></div>
            <div class="bar-container">
                <div class="bar-fill" id="bar-c"></div>
            </div>

            <div class="meter-row"><span>Voltage (V):</span> <span class="val" id="disp-v">Loading...</span></div>
            <div class="bar-container">
                <div class="bar-fill" id="bar-v" style="background: var(--accent)"></div>
            </div>
        </div>
    </main>

    <script>
        // --- Physics State ---
        const state = {
            distance: 100,      // Separation in pixels
            dielectricPos: 0,   // 0 to 1 (0 = outside, 1 = fully inside)
            kappa: 4.0,         // Dielectric constant
            charge: 100,        // Fixed Charge amount
            stepIndex: 0
        };

        // --- Canvas Setup ---
        const canvas = document.getElementById('simCanvas');
        const ctx = canvas.getContext('2d');
        let width, height;

        function resize() {
            const parent = document.getElementById('viewport');
            width = parent.offsetWidth - 40;
            height = parent.offsetHeight - 40;
            canvas.width = width;
            canvas.height = height;
        }
        window.addEventListener('resize', resize);

        // --- Physics Calculations ---
        function getPhysics() {
            // C = (epsilon * A) / d
            // epsilon increases with dielectric insertion
            // We model effective kappa based on insertion percentage
            const effectiveKappa = 1 + (state.dielectricPos * (state.kappa - 1));

            // Normalized Capacitance
            // Higher distance = Lower C. Higher Kappa = Higher C.
            const C = (effectiveKappa * 200) / state.distance;

            // V = Q / C
            // Since Q is constant (100), V depends inversely on C.
            const V = state.charge / C;

            // Electric Field E = V / d
            const E = V / state.distance;

            return { C, V, E, effectiveKappa };
        }

        // --- Drawing Loop ---
        function draw() {
            // 1. Clear
            ctx.fillStyle = "#111";
            ctx.fillRect(0, 0, width, height);

            const cx = width / 2;
            const cy = height / 2;
            const plateW = 300;
            const plateH = 20;
            const d = state.distance;

            const physics = getPhysics();

            // 2. Draw Battery Wires (Disconnected)
            ctx.strokeStyle = "#444";
            ctx.lineWidth = 2;
            // Top wire
            ctx.beginPath(); ctx.moveTo(cx, cy - d / 2); ctx.lineTo(cx, cy - d / 2 - 60); ctx.stroke();
            // Bottom wire
            ctx.beginPath(); ctx.moveTo(cx, cy + d / 2); ctx.lineTo(cx, cy + d / 2 + 60); ctx.stroke();

            // Draw "Open Switch" / Broken circuit symbols
            ctx.fillStyle = "#ff6b6b";
            ctx.beginPath(); ctx.arc(cx, cy - d / 2 - 60, 4, 0, Math.PI * 2); ctx.fill();
            ctx.beginPath(); ctx.arc(cx, cy + d / 2 + 60, 4, 0, Math.PI * 2); ctx.fill();
            ctx.font = "12px monospace"; ctx.fillStyle = "#666";
            ctx.fillText("DISCONNECTED", cx + 10, cy - d / 2 - 55);

            // 3. Draw Dielectric
            const slabW = plateW;
            const slabH = d - plateH;
            const slabX = (cx - plateW / 2) + (state.dielectricPos * plateW) - plateW; // slide from left

            if (state.dielectricPos > 0.01) {
                ctx.save();
                // Mask to only show what's between plates
                ctx.beginPath();
                ctx.rect(cx - plateW / 2, cy - d / 2 + plateH / 2, plateW, d - plateH);
                ctx.clip();

                // Draw Slab
                ctx.fillStyle = "rgba(255, 159, 67, 0.3)"; // Orange tint
                ctx.fillRect(slabX, cy - d / 2 + plateH / 2, plateW, d - plateH);

                // Draw Bound Charges (Induced)
                ctx.font = "bold 14px Arial";
                ctx.textAlign = "center";
                const numCharges = 8;
                for (let i = 0; i < numCharges; i++) {
                    let lx = slabX + (i + 0.5) * (plateW / numCharges);
                    if (lx > cx - plateW / 2 && lx < cx + plateW / 2) {
                        ctx.fillStyle = "rgba(255,255,255,0.4)";
                        // Top of slab (negative bound charges facing top positive plate)
                        ctx.fillText("-", lx, cy - d / 2 + plateH + 5);
                        // Bottom of slab (positive bound charges)
                        ctx.fillText("+", lx, cy + d / 2 - plateH - 5);
                    }
                }
                ctx.restore();
            }

            // 4. Draw Plates
            ctx.fillStyle = "#777";
            // Top Plate
            ctx.fillRect(cx - plateW / 2, cy - d / 2, plateW, plateH);
            // Bottom Plate
            ctx.fillRect(cx - plateW / 2, cy + d / 2 - plateH, plateW, plateH);

            // 5. Draw Fixed Charges (Q)
            // Since Q is constant, we always draw the same number of charges!
            ctx.font = "bold 16px Arial";
            ctx.textAlign = "center";
            const qCount = 10;
            const qSpacing = plateW / (qCount + 1);

            for (let i = 1; i <= qCount; i++) {
                let px = (cx - plateW / 2) + i * qSpacing;

                // Top (Pos)
                ctx.fillStyle = "#ff6b6b";
                ctx.fillText("+", px, cy - d / 2 + 15);

                // Bottom (Neg)
                ctx.fillStyle = "#54a0ff";
                ctx.fillText("-", px, cy + d / 2 - 5);
            }

            // 6. Electric Field Lines
            // E = V/d. In vacuum with const Q, E is constant.
            // With dielectric, E_net reduces.

            // Visual opacity = Field Strength relative to vacuum max
            const opacity = Math.min(1, physics.E / 0.5);

            ctx.strokeStyle = `rgba(255, 159, 67, ${opacity})`;
            ctx.lineWidth = 2;
            ctx.setLineDash([5, 5]); // Dashed lines for field

            // Only draw lines within plate area
            const lines = 12;
            for (let i = 1; i < lines; i++) {
                let lx = (cx - plateW / 2) + i * (plateW / lines);
                ctx.beginPath();
                ctx.moveTo(lx, cy - d / 2 + plateH);
                ctx.lineTo(lx, cy + d / 2 - plateH);
                ctx.stroke();

                // Arrow
                ctx.beginPath();
                ctx.moveTo(lx, cy + d / 2 - plateH);
                ctx.lineTo(lx - 3, cy + d / 2 - plateH - 10);
                ctx.lineTo(lx + 3, cy + d / 2 - plateH - 10);
                ctx.fillStyle = `rgba(255, 159, 67, ${opacity})`;
                ctx.fill();
            }
            ctx.setLineDash([]);

            // 7. Dimension Arrows
            ctx.strokeStyle = "#fff";
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.moveTo(cx + plateW / 2 + 20, cy - d / 2);
            ctx.lineTo(cx + plateW / 2 + 20, cy + d / 2);
            ctx.stroke();
            // Arrow heads
            // ... (simplified for brevity)

            updateMeters(physics);
            requestAnimationFrame(draw);
        }

        function updateMeters(phys) {
            // Update UI bars
            const maxV = 100; // arbitrary scale factor
            const maxC = 20;

            document.getElementById('disp-v').innerText = phys.V.toFixed(2) + " V";
            document.getElementById('bar-v').style.width = Math.min(100, (phys.V * 2)) + "%"; // Scale for visibility

            // Color change for Voltage (Red = Danger/High Energy)
            if (phys.V > 35) document.getElementById('bar-v').style.background = "#ff6b6b";
            else document.getElementById('bar-v').style.background = "#ff9f43";

            document.getElementById('disp-c').innerText = phys.C.toFixed(2) + " F";
            document.getElementById('bar-c').style.width = Math.min(100, (phys.C * 10)) + "%";
        }

        // --- Storytelling & Logic ---

        const steps = [
            {
                title: "1. The Setup: Trapped Charge",
                text: "We have charged this capacitor and <strong>disconnected the battery</strong>.<br><br>The charge $Q$ is now stranded on the plates. It has nowhere to go.<br><br>$$Q = \\text{constant}$$<br>Currently, the Voltage is determined by the gap distance.",
                controls: ``,
                init: () => { state.distance = 100; state.dielectricPos = 0; }
            },
            {
                title: "2. The Stretch (Pulling Apart)",
                text: "Try increasing the distance between the plates.<br><br><strong>Watch the Voltage bar.</strong> Why does it skyrocket?<br><br>Because the $+$ and $-$ plates attract each other. Pulling them apart requires <strong>mechanical work</strong>. You are adding energy to the system.<br><br>$$V = \\frac{\\text{Energy}}{Q}$$<br>More Energy + Constant Charge = <strong>Higher Voltage</strong>.",
                controls: `
                    <div class="control-group">
                        <label>Distance (d)</label>
                        <input type="range" min="50" max="300" value="100" oninput="state.distance = parseInt(this.value)">
                    </div>
                `,
                init: () => { state.dielectricPos = 0; }
            },
            {
                title: "3. First Principles Check",
                text: "Mathematically, we know:<br>$$C = \\frac{\\epsilon_0 A}{d}$$<br>If you increase $d$, Capacitance ($C$) drops.<br><br>Since $Q$ is locked:<br>$$V = \\frac{Q}{C}$$<br>As $C$ drops, $V$ must rise. The field lines ($E$) actually stay constant density, but they have to span a longer distance ($V = E \\cdot d$), so $V$ grows.",
                controls: `
                    <div class="control-group">
                        <label>Distance (d)</label>
                        <input type="range" min="50" max="300" value="200" oninput="state.distance = parseInt(this.value)">
                    </div>`,
                init: () => { state.distance = 200; state.dielectricPos = 0; }
            },
            {
                title: "4. The Cushion (Dielectric)",
                text: "Now, let's reset the distance and insert a dielectric (like glass).<br><br>Slide the block in. <strong>Watch the Voltage drop.</strong><br><br>Why? The material gets polarized. Tiny dipoles inside the glass align against the field. This cancels out some of the electric field.",
                controls: `
                    <div class="control-group">
                        <label>Dielectric Insertion</label>
                        <input type="range" min="0" max="100" value="0" oninput="state.dielectricPos = this.value/100">
                    </div>
                `,
                init: () => { state.distance = 150; state.dielectricPos = 0; }
            },
            {
                title: "Conclusion",
                text: "The Net Electric Field is weaker inside the dielectric.<br>$$E_{net} = \\frac{E_{original}}{\\kappa}$$<br>Voltage is the \"effort\" to push a charge from one plate to the other. If the field opposing you is weaker, the Voltage is lower.<br><br>$$V_{new} = \\frac{V_{old}}{\\kappa}$$",
                controls: `
                     <div class="control-group">
                        <label>Dielectric Insertion</label>
                        <input type="range" min="0" max="100" value="100" oninput="state.dielectricPos = this.value/100">
                    </div>
                `,
                init: () => {
                    state.distance = 150;
                    state.dielectricPos = 1;
                }
            }
        ];

        function loadStep(idx) {
            state.stepIndex = idx;
            const s = steps[idx];
            const container = document.getElementById('story-container');
            const controls = document.getElementById('controls');

            container.innerHTML = `<div class="chapter-title">${s.title}</div><div class="text-content">${s.text}</div>`;
            controls.innerHTML = s.controls;

            // Handle Nav Buttons
            document.getElementById('prevBtn').classList.toggle('disabled', idx === 0);

            const btn = document.getElementById('nextBtn');
            if (state.stepIndex === steps.length - 1) {
                btn.innerHTML = "Next Lesson";
                btn.classList.remove('disabled');
            } else {
                btn.innerHTML = "Next";
                btn.classList.remove('disabled');
            }

            if (s.init) s.init();

            // Safe render check
            if (window.renderMathInElement) {
                renderMathInElement(container, {
                    delimiters: [
                        { left: "$$", right: "$$", display: true },
                        { left: "$", right: "$", display: false }
                    ]
                });
            }
        }

        function nextStep() {
            if (state.stepIndex < steps.length - 1) {
                loadStep(state.stepIndex + 1);
            } else {
                window.location.href = '/theapplefalls/lessons/chapter7/5_experiments_connected.html';
            }
        }
        function prevStep() {
            if (state.stepIndex > 0) loadStep(state.stepIndex - 1);
        }

        // --- Init with Saftey Check for Defer Scripts ---
        document.addEventListener("DOMContentLoaded", () => {
            resize();
            loadStep(0);
            draw();
        });

    </script>
</body>

</html>