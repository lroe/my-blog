<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Maxwell's Notebook: The Dielectric Constant</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/katex.min.css">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/katex.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/contrib/auto-render.min.js"
        onload="renderMathInElement(document.body);"></script>

    <style>
        :root {
            --bg: #151515;
            --panel: #1e1e1e;
            --text: #dcdcdc;
            --accent: #ff9f43;
            --energy: #00cec9;
            --pos-charge: #ff5e57;
            --neg-charge: #48dbfb;
            --field-free: #ffdd59;
            --field-ind: #a29bfe;
            --border: #333;
        }

        body {
            margin: 0;
            height: 100vh;
            display: flex;
            background: var(--bg);
            color: var(--text);
            font-family: 'Segoe UI', sans-serif;
            overflow: hidden;
        }

        aside {
            width: 450px;
            background: var(--panel);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            z-index: 10;
            box-shadow: 10px 0 30px rgba(0, 0, 0, 0.5);
        }

        header {
            padding: 20px;
            border-bottom: 1px solid var(--border);
        }

        h1 {
            margin: 0;
            font-size: 18px;
            color: var(--accent);
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .subtitle {
            font-size: 12px;
            color: #888;
            margin-top: 5px;
        }

        #story-container {
            flex: 1;
            padding: 25px;
            overflow-y: auto;
        }

        .chapter-title {
            font-size: 22px;
            color: #fff;
            margin-bottom: 15px;
            border-left: 3px solid var(--accent);
            padding-left: 10px;
        }

        .text-content {
            line-height: 1.6;
            font-size: 15px;
            color: #ccc;
            text-align: justify;
            margin-bottom: 15px;
        }

        .math-block {
            background: #222;
            padding: 12px;
            border-radius: 4px;
            border: 1px solid #333;
            text-align: center;
            margin: 15px 0;
            color: var(--energy);
            font-size: 1.1em;
        }

        #controls {
            background: #111;
            padding: 20px;
            border-top: 1px solid var(--border);
        }

        .slider-container {
            margin-bottom: 15px;
        }

        .slider-label {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: #aaa;
            margin-bottom: 5px;
        }

        input[type=range] {
            width: 100%;
            cursor: pointer;
            accent-color: var(--accent);
        }

        select {
            width: 100%;
            padding: 10px;
            background: #222;
            color: #fff;
            border: 1px solid #444;
            border-radius: 4px;
            font-size: 14px;
            margin-bottom: 10px;
        }

        #nav {
            padding: 15px;
            display: flex;
            gap: 10px;
            background: #000;
            border-top: 1px solid var(--border);
        }

        .nav-btn {
            flex: 1;
            text-decoration: none;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #2a2a2a;
            color: #fff;
            border: 1px solid #444;
            padding: 12px;
            font-weight: bold;
            transition: 0.2s;
            text-transform: uppercase;
            font-size: 12px;
            cursor: pointer;
        }

        .nav-btn:hover {
            background: var(--accent);
            color: #111;
            border-color: var(--accent);
        }

        .next-btn {
            background: var(--accent);
            color: #111;
            border: none;
        }

        main {
            flex: 1;
            position: relative;
            background: radial-gradient(circle at center, #1a1a1a 0%, #080808 100%);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        canvas {
            box-shadow: 0 0 50px rgba(0, 0, 0, 0.5);
            border-radius: 4px;
        }

        #hud {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(20, 20, 20, 0.9);
            border: 1px solid #444;
            border-radius: 8px;
            padding: 15px;
            width: 240px;
            pointer-events: none;
        }

        .hud-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 6px;
            font-size: 13px;
            color: #aaa;
        }

        .hud-val {
            font-weight: bold;
            color: #fff;
            font-family: monospace;
        }

        .hud-hl {
            color: var(--accent);
        }

        .hud-ind {
            color: var(--field-ind);
        }

        strong {
            color: #fff;
            font-weight: 600;
        }
    </style>
</head>

<body>

    <aside>
        <header>
            <h1>Maxwell's Notebook</h1>
            <div class="subtitle">Chapter 7: The Dielectric Constant</div>
        </header>
        <div id="story-container"></div>
        <div id="controls">
            <div id="dynamic-controls"></div>
        </div>
        <div id="nav">
            <button class="nav-btn" onclick="prevStep()">Back</button>
            <button class="nav-btn next-btn" onclick="nextStep()">Next</button>
        </div>
    </aside>

    <main id="viewport">
        <canvas id="simCanvas"></canvas>
        <div id="hud">
            <div class="hud-row"><span>Free Field ($\vec{E}_0$):</span> <span class="hud-val"
                    style="color:var(--field-free)" id="disp-ef">100</span></div>
            <div class="hud-row"><span>Induced Field ($\vec{E}_i$):</span> <span class="hud-val"
                    style="color:var(--field-ind)" id="disp-ei">0</span></div>
            <div class="hud-row"><span>Net Field ($\vec{E}_{net}$):</span> <span class="hud-val hud-hl"
                    id="disp-enet">100</span></div>
            <div style="border-top:1px solid #444; margin-top:5px; padding-top:5px;" class="hud-row">
                <span>Dielectric Constant ($\kappa$):</span> <span class="hud-val hud-hl" id="disp-kappa">1.0</span>
            </div>
            <div class="hud-row"><span>Capacitance ($C$):</span> <span class="hud-val" style="color:#00cec9"
                    id="disp-cap">1.0 $C_0$</span></div>
        </div>
    </main>

    <script>
        const config = {
            kappa: 1,
            insertion: 0, // 0 to 1 represents the "fill" of the dielectric
            material: "Vacuum"
        };

        const materials = {
            "Vacuum": 1,
            "Paper": 3.7,
            "Plastic": 3.0,
            "Glass": 5.0,
            "Water": 80.0
        };

        const canvas = document.getElementById('simCanvas');
        const ctx = canvas.getContext('2d');

        function resize() {
            const parent = document.getElementById('viewport');
            canvas.width = parent.offsetWidth - 40;
            canvas.height = parent.offsetHeight - 40;
        }
        window.addEventListener('resize', resize);

        function drawCapacitor(cx, cy) {
            const w = 400; // Plate width
            const h = 20;  // Plate thickness
            const d = 250; // Separation distance

            // 1. Draw Plates
            ctx.fillStyle = "#555";
            // Top Plate
            ctx.beginPath(); ctx.roundRect(cx - w / 2, cy - d / 2, w, h, 5); ctx.fill();
            // Bottom Plate
            ctx.beginPath(); ctx.roundRect(cx - w / 2, cy + d / 2 - h, w, h, 5); ctx.fill();

            // Plate Charges (Free Charge)
            ctx.font = "bold 16px monospace";
            ctx.textAlign = "center";
            ctx.fillStyle = "#fff";
            for (let i = 0; i < 10; i++) {
                let x = (cx - w / 2) + (i + 1) * (w / 11);
                ctx.fillStyle = "rgba(255, 94, 87, 0.9)"; // Pos
                ctx.fillText("+", x, cy - d / 2 + 16);
                ctx.fillStyle = "rgba(72, 219, 251, 0.9)"; // Neg
                ctx.fillText("-", x, cy + d / 2 - h - 5);
            }

            // 2. Dielectric Slab
            if (config.insertion > 0.01) {
                const slabW = w * 0.9;
                const maxSlabH = (d - 2 * h);
                const currentSlabH = maxSlabH * config.insertion;

                const slabTopY = cy - d / 2 + h;
                const slabBottomY = slabTopY + currentSlabH;

                // Color based on material
                ctx.fillStyle = "rgba(72, 219, 251, 0.2)";
                if (config.material === "Glass") ctx.fillStyle = "rgba(162, 155, 254, 0.3)";
                if (config.material === "Water") ctx.fillStyle = "rgba(0, 206, 201, 0.4)";

                ctx.fillRect(cx - slabW / 2, slabTopY, slabW, currentSlabH);
                ctx.strokeStyle = "rgba(255,255,255,0.3)";
                ctx.strokeRect(cx - slabW / 2, slabTopY, slabW, currentSlabH);

                // --- BOUND CHARGES (FIXED LOGIC) ---
                // Negative bound charges appear at the TOP of the dielectric (facing + plate)
                // Positive bound charges appear at the BOTTOM of the dielectric (facing - plate)
                // They should appear as long as the slab exists.

                const count = 12;
                const step = slabW / (count + 1);
                const chargeAlpha = Math.min(1, config.insertion * 3); // Fade in

                ctx.save();

                // Draw Negatives (Top Surface)
                ctx.fillStyle = `rgba(72, 219, 251, ${chargeAlpha})`;
                for (let i = 1; i <= count; i++) {
                    ctx.fillText("-", cx - slabW / 2 + i * step, slabTopY + 18);
                }

                // Draw Positives (Bottom Surface - Moving with insertion)
                // Only draw if slab is thick enough to not overlap
                if (currentSlabH > 30) {
                    ctx.fillStyle = `rgba(255, 94, 87, ${chargeAlpha})`;
                    for (let i = 1; i <= count; i++) {
                        ctx.fillText("+", cx - slabW / 2 + i * step, slabBottomY - 8);
                    }
                }
                ctx.restore();
            }
        }

        function drawFields(cx, cy) {
            const d = 250;
            const h = 20;
            const startY = cy - d / 2 + h;
            const endY = cy + d / 2 - h;
            const spacing = 40;

            const freeE = 100; // Arbitrary units
            const indE = freeE * (1 - 1 / config.kappa) * config.insertion;
            const netE = freeE - indE;

            // 1. Free Field Lines (E0) - Always present, background layer
            // Represented as thin, faint yellow lines
            ctx.save();
            ctx.strokeStyle = "rgba(255, 221, 89, 0.2)";
            ctx.setLineDash([5, 5]);
            ctx.lineWidth = 1;
            for (let x = cx - 180; x <= cx + 180; x += spacing) {
                ctx.beginPath(); ctx.moveTo(x, startY); ctx.lineTo(x, endY); ctx.stroke();
            }
            ctx.restore();

            // 2. Net Field Lines (The result)
            // Color shifts from Yellow (Free) to Orange (Net)
            ctx.strokeStyle = "#ff9f43";
            ctx.lineWidth = 3;
            // Opacity represents strength relative to vacuum
            const strengthRatio = netE / 100;

            for (let x = cx - 160; x <= cx + 160; x += spacing) {
                // Inside the dielectric, field is reduced
                if (config.insertion > 0 && Math.abs(x - cx) < 180) {
                    ctx.globalAlpha = Math.max(0.2, strengthRatio);
                } else {
                    ctx.globalAlpha = 1.0;
                }

                ctx.beginPath(); ctx.moveTo(x, startY + 10); ctx.lineTo(x, endY - 10); ctx.stroke();

                // Arrow Head
                ctx.beginPath();
                ctx.moveTo(x, endY - 10);
                ctx.lineTo(x - 5, endY - 20);
                ctx.lineTo(x + 5, endY - 20);
                ctx.fillStyle = "#ff9f43";
                ctx.fill();
            }
            ctx.globalAlpha = 1.0;

            // 3. Induced Field (Ei) - Only shows vector pointing UP
            // Only drawn if we are in Step 2 or later (educational clarity)
            if (config.insertion > 0 && currentStep >= 1) {
                const slabH = (d - 2 * h) * config.insertion;
                ctx.strokeStyle = "#a29bfe";
                ctx.lineWidth = 2;

                // Draw these interleaved with main fields
                for (let x = cx - 140; x <= cx + 140; x += spacing) {
                    // Only draw inside current slab height
                    if (slabH > 40) {
                        ctx.beginPath();
                        ctx.moveTo(x + 10, startY + slabH - 10);
                        ctx.lineTo(x + 10, startY + 10);
                        ctx.stroke();
                        // Arrow pointing UP (opposing)
                        ctx.beginPath();
                        ctx.moveTo(x + 10, startY + 10);
                        ctx.lineTo(x + 6, startY + 18);
                        ctx.lineTo(x + 14, startY + 18);
                        ctx.fillStyle = "#a29bfe";
                        ctx.fill();
                    }
                }
            }

            // HUD Update
            document.getElementById('disp-ef').innerText = freeE.toFixed(0);
            document.getElementById('disp-ei').innerText = indE.toFixed(0);
            document.getElementById('disp-enet').innerText = netE.toFixed(0);
            document.getElementById('disp-kappa').innerText = config.kappa.toFixed(1);

            // Capacitance proportional to Kappa * Area (Area is const here, so just Kappa)
            // But effectively, if we fill partially, it's effectively 2 capacitors in series...
            // For simplicity in this visualization, we assume C scales with the *effective* kappa of the system
            // C = Q / V. Q is const. V = E*d. E decreases. So C increases.
            const effectiveC = 100 / netE;
            document.getElementById('disp-cap').innerText = effectiveC.toFixed(2) + " C₀";
        }

        function loop() {
            ctx.fillStyle = "#0c0c0c";
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            const cx = canvas.width / 2;
            const cy = canvas.height / 2;

            drawCapacitor(cx, cy);
            drawFields(cx, cy);

            requestAnimationFrame(loop);
        }

        // --- Educational Content ---

        const steps = [
            {
                title: "1. Bound Surface Charge",
                text: "When the dielectric is inserted, the external field aligns the atomic dipoles. <br><br>While the dipoles inside cancel each other out, the ones at the surfaces are left uncancelled. This creates a sheet of **negative charge** at the top and **positive charge** at the bottom.<br><br>Notice how the charges 'ride' the edges of the material as it forms.",
                setup: () => { config.kappa = 5; config.material = "Glass"; },
                controls: `
                <div class="slider-container">
                    <div class="slider-label"><span>Insert Dielectric (Fill %)</span></div>
                    <input type="range" min="0" max="1" step="0.01" value="${config.insertion}" oninput="config.insertion = parseFloat(this.value)">
                </div>`
            },
            {
                title: "2. The War of Fields",
                text: "These Bound Charges ($\sigma_b$) create their own electric field, the **Induced Field** ($\vec{E}_{ind}$), shown in <span style='color:#a29bfe'>purple</span>. <br><br>Crucially, $\vec{E}_{ind}$ points in the **opposite direction** to the external Free Field ($\vec{E}_0$).<br><br>The Net Field is the vector sum: <div class='math-block'>$$ \\vec{E}_{net} = \\vec{E}_0 - \\vec{E}_{ind} $$</div>",
                setup: () => { config.insertion = 1; },
                controls: `<div style="text-align:center; color:#888;">Observe the purple vectors opposing the yellow/orange ones.</div>`
            },
            {
                title: "3. The Dielectric Constant",
                text: "We define the **Dielectric Constant** ($\kappa$ or $K$) as the ratio of the original field to the reduced net field.<br><br>A higher $\kappa$ means the material is easier to polarize, creating a stronger opposing field, resulting in a weaker net field inside.<div class='math-block'>$$ \\kappa = \\frac{E_0}{E_{net}} $$</div>",
                setup: () => { config.insertion = 1; },
                controls: `
                <div class="slider-label"><span>Select Material</span></div>
                <select onchange="config.kappa = materials[this.value]; config.material = this.value">
                    <option value="Vacuum">Vacuum (κ=1)</option>
                    <option value="Plastic">Plastic (κ=3)</option>
                    <option value="Glass" selected>Glass (κ=5)</option>
                    <option value="Water">Water (κ=80)</option>
                </select>`
            },
            {
                title: "Conclusion",
                text: "Why do we care? For a capacitor, Voltage is $V = E \\cdot d$. <br><br>If the Dielectric reduces $E$, it reduces $V$ for the same amount of Charge ($Q$).<br><br>Since Capacitance $C = Q/V$, a lower Voltage means a **higher Capacitance**. <div class='math-block'>$$ C = \\kappa C_0 $$</div>",
                setup: () => {
                    config.insertion = 1;
                    config.kappa = 5;
                    config.material = "Glass";
                    document.getElementById('btn-next').innerText = "Next Lesson";
                },
                controls: `<div style="text-align:center; color:#00cec9;">Check the Capacitance value in the HUD.</div>`
            }
        ];

        let currentStep = 0;
        function loadStep(idx) {
            currentStep = idx;
            const s = steps[idx];
            document.getElementById('story-container').innerHTML = `<div class="chapter-title">${s.title}</div><div class="text-content">${s.text}</div>`;
            document.getElementById('dynamic-controls').innerHTML = s.controls;
            if (typeof renderMathInElement === 'function') {
                renderMathInElement(document.getElementById('story-container'), {
                    delimiters: [{ left: "$$", right: "$$", display: true }, { left: "$", right: "$", display: false }]
                });
            }
            if (s.setup) s.setup();

            const btn = document.querySelector('.next-btn');
            if (currentStep === steps.length - 1) {
                btn.innerHTML = "Next Lesson";
                btn.disabled = false;
            } else {
                btn.innerHTML = "Next";
                btn.disabled = false;
            }

            // Sync slider if exists
            const slider = document.querySelector('input[type=range]');
            if (slider) slider.value = config.insertion;
        }

        function nextStep() {
            if (currentStep < steps.length - 1) {
                loadStep(currentStep + 1);
            } else {
                window.location.href = '/theapplefalls/lessons/chapter7/3_gauss_law_dielectrics.html';
            }
        }

        function prevStep() {
            if (currentStep > 0) loadStep(currentStep - 1);
        }

        window.addEventListener('load', () => {
            resize();
            loadStep(0);
            loop();
        });
    </script>
</body>

</html>