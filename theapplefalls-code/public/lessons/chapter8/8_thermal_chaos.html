<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Maxwell's Notebook: The Thermal Chaos</title>
    <!-- KaTeX for Math -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/katex.min.css">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/katex.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/contrib/auto-render.min.js"
        onload="renderMathInElement(document.body);"></script>

    <style>
        :root {
            --bg: #151515;
            --panel: #1e1e1e;
            --text: #dcdcdc;
            --accent: #ff9f43;
            --border: #333;
            --electron: #48dbfb;
            --ion: #555;
            --hot: #ff4757;
            --impurity: #ccff00;
        }

        body {
            margin: 0;
            min-height: 100vh;
            display: flex;
            background: var(--bg);
            color: var(--text);
            font-family: 'Segoe UI', sans-serif;
            overflow: hidden;
        }

        aside {
            width: 420px;
            background: var(--panel);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            z-index: 10;
            box-shadow: 10px 0 30px rgba(0, 0, 0, 0.5);
        }

        header {
            padding: 25px;
            border-bottom: 1px solid var(--border);
            background: #1a1a1a;
        }

        h1 {
            margin: 0;
            font-size: 20px;
            color: var(--accent);
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .subtitle {
            font-size: 14px;
            color: #888;
            margin-top: 5px;
            font-style: italic;
        }

        #story-container {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
        }

        .chapter-title {
            font-size: 22px;
            color: #fff;
            margin-bottom: 20px;
            border-left: 3px solid var(--accent);
            padding-left: 15px;
            font-weight: 300;
        }

        .text-content {
            line-height: 1.7;
            font-size: 17px;
            color: #ccc;
            text-align: left;
            margin-bottom: 20px;
        }

        .concept-block {
            background: rgba(255, 255, 255, 0.03);
            padding: 15px;
            border-radius: 8px;
            border-left: 3px solid var(--accent);
            margin-bottom: 20px;
            font-size: 15px;
        }

        #controls {
            background: #111;
            padding: 25px;
            border-top: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        label {
            font-size: 11px;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
        }

        label span {
            color: var(--accent);
        }

        .slider {
            appearance: none;
            -webkit-appearance: none;
            width: 100%;
            height: 6px;
            background: #333;
            border-radius: 5px;
            outline: none;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            background: var(--accent);
            cursor: pointer;
            border-radius: 50%;
        }

        .btn-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .action-btn {
            background: #2a2a2a;
            border: 1px solid #444;
            color: #fff;
            padding: 12px;
            border-radius: 6px;
            cursor: pointer;
            transition: 0.3s;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: bold;
        }

        .action-btn:hover {
            border-color: var(--accent);
            color: var(--accent);
        }

        #nav {
            padding: 20px;
            display: flex;
            gap: 15px;
            background: #000;
            border-top: 1px solid var(--border);
        }

        .nav-btn {
            flex: 1;
            border: none;
            background: #2a2a2a;
            color: #fff;
            border: 1px solid #444;
            padding: 14px;
            font-weight: bold;
            transition: 0.2s;
            text-transform: uppercase;
            font-size: 11px;
            letter-spacing: 1px;
            cursor: pointer;
            border-radius: 4px;
            text-align: center;
            text-decoration: none;
        }

        .nav-btn:hover {
            background: var(--accent);
            color: #111;
            border-color: var(--accent);
        }

        main {
            flex: 1;
            position: relative;
            background: #050505;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        #sim-canvas {
            background: #000;
            border: 1px solid #222;
            cursor: crosshair;
            box-shadow: 0 0 50px rgba(0, 0, 0, 0.8);
        }

        #stats-overlay {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.7);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #333;
            font-family: monospace;
            z-index: 5;
            pointer-events: none;
        }

        .stat-row {
            display: flex;
            justify-content: space-between;
            gap: 20px;
            font-size: 13px;
            margin-bottom: 5px;
        }

        .stat-val {
            color: var(--accent);
            font-weight: bold;
        }
    </style>
</head>

<body>
    <aside>
        <header>
            <h1>Maxwell's Notebook</h1>
            <div class="subtitle">Chapter 8: The Thermal Chaos</div>
        </header>

        <div id="story-container"></div>

        <div id="controls">
            <div id="dynamic-controls"></div>
        </div>

        <div id="nav">
            <a href="6_the_birth_of_ohms_law.html" class="nav-btn">Back</a>
            <button class="nav-btn next-btn" id="btn-next" onclick="nextStep()">Next</button>
        </div>
    </aside>

    <main id="viewport">
        <div id="stats-overlay" style="opacity: 0; transition: opacity 0.5s;">
            <div class="stat-row">Collisions/sec: <span id="stat-col" class="stat-val">0</span></div>
            <div class="stat-row">Net Speed: <span id="stat-speed" class="stat-val">0.0</span></div>
            <div class="stat-row">Efficiency: <span id="stat-eff" class="stat-val">100%</span></div>
        </div>
        <canvas id="sim-canvas"></canvas>
    </main>

    <script>
        const canvas = document.getElementById('sim-canvas');
        const ctx = canvas.getContext('2d');
        const viewport = document.getElementById('viewport');
        const statsOverlay = document.getElementById('stats-overlay');

        let width, height;
        let ions = [];
        let particles = [];
        let impurities = [];
        let voltage = 15;
        let temp = 2;
        let collisionCount = 0;
        let frames = 0;

        function resize() {
            width = viewport.clientWidth - 100;
            height = viewport.clientHeight - 100;
            canvas.width = width;
            canvas.height = height;
            initLattice();
            initParticles();
        }

        function initLattice() {
            ions = [];
            const spacing = 60;
            for (let x = spacing; x < width; x += spacing) {
                for (let y = spacing; y < height; y += spacing) {
                    ions.push({
                        x, y,
                        origX: x, origY: y,
                        heat: 0,
                        radius: 8
                    });
                }
            }
        }

        function initParticles() {
            particles = [];
            const count = 30;
            for (let i = 0; i < count; i++) {
                particles.push(new Particle());
            }
        }

        class Particle {
            constructor() {
                this.reset();
            }
            reset() {
                this.x = Math.random() * -20;
                this.y = Math.random() * height;
                this.vx = voltage * 0.2 + Math.random() * 2;
                this.vy = (Math.random() - 0.5) * 2;
                this.color = 'var(--electron)';
            }
            update() {
                this.vx += voltage * 0.005; // Acceleration due to field

                this.x += this.vx;
                this.y += this.vy;

                // Collision Detection - Ions
                ions.forEach(ion => {
                    const dx = this.x - ion.x;
                    const dy = this.y - ion.y;
                    const dist = Math.sqrt(dx * dx + dy * dy);
                    const hitRadius = ion.radius + (temp * 0.8); // Larger hit radius when shaking

                    if (dist < hitRadius) {
                        this.vx *= -0.2; // Energy loss
                        this.vy += (Math.random() - 0.5) * 10;
                        ion.heat = Math.min(ion.heat + 50, 255);
                        collisionCount++;
                    }
                });

                // Collision Detection - Impurities
                impurities.forEach(imp => {
                    const dx = this.x - imp.x;
                    const dy = this.y - imp.y;
                    const dist = Math.sqrt(dx * dx + dy * dy);
                    if (dist < 10) {
                        this.vx *= -0.5;
                        this.vy = (Math.random() - 0.5) * 15;
                        collisionCount++;
                    }
                });

                if (this.x > width) this.reset();
                if (this.y < 0 || this.y > height) this.vy *= -1;
            }
            draw() {
                ctx.fillStyle = this.color;
                ctx.beginPath();
                ctx.arc(this.x, this.y, 3, 0, Math.PI * 2);
                ctx.fill();

                ctx.strokeStyle = 'rgba(72, 219, 251, 0.1)';
                ctx.lineWidth = 1;
                ctx.beginPath();
                ctx.moveTo(this.x, this.y);
                ctx.lineTo(this.x - this.vx * 2, this.y - this.vy * 2);
                ctx.stroke();
            }
        }

        function addImpurity() {
            impurities.push({
                x: Math.random() * width,
                y: Math.random() * height
            });
        }

        function resetSim() {
            impurities = [];
            collisionCount = 0;
            initParticles();
        }

        function updateParams() {
            const vs = document.getElementById('v-slider');
            const ts = document.getElementById('t-slider');
            const vl = document.getElementById('v-label');
            const tl = document.getElementById('t-label');

            if (vs) voltage = parseFloat(vs.value);
            if (ts) temp = parseFloat(ts.value);
            if (vl) vl.innerText = voltage + "V";
            if (tl) tl.innerText = temp < 5 ? "Low" : (temp < 15 ? "High" : "Extreme");
        }

        function animate() {
            ctx.fillStyle = '#000';
            ctx.fillRect(0, 0, width, height);

            // Draw Ions
            ions.forEach(ion => {
                // Shaking
                ion.x = ion.origX + (Math.random() - 0.5) * temp;
                ion.y = ion.origY + (Math.random() - 0.5) * temp;

                // Color based on heat
                const r = Math.floor(85 + ion.heat);
                const g = Math.floor(85 - ion.heat / 3);
                const b = Math.floor(85 - ion.heat / 3);
                ctx.fillStyle = `rgb(${r}, ${g}, ${b})`;

                ctx.beginPath();
                ctx.arc(ion.x, ion.y, ion.radius, 0, Math.PI * 2);
                ctx.fill();

                if (ion.heat > 0) ion.heat -= 2; // Cool down
            });

            // Draw Impurities
            impurities.forEach(imp => {
                ctx.strokeStyle = 'var(--impurity)';
                ctx.lineWidth = 3;
                ctx.shadowBlur = 15;
                ctx.shadowColor = 'var(--impurity)';
                ctx.beginPath();
                // Draw a bright 'X'
                ctx.moveTo(imp.x - 7, imp.y - 7);
                ctx.lineTo(imp.x + 7, imp.y + 7);
                ctx.moveTo(imp.x + 7, imp.y - 7);
                ctx.lineTo(imp.x - 7, imp.y + 7);
                ctx.stroke();
                ctx.shadowBlur = 0;
            });

            // Update & Draw Particles
            let totalVX = 0;
            particles.forEach(p => {
                p.update();
                p.draw();
                totalVX += p.vx;
            });

            // Update Stats
            frames++;
            if (frames % 30 === 0) {
                const colStat = document.getElementById('stat-col');
                const speedStat = document.getElementById('stat-speed');
                const effStat = document.getElementById('stat-eff');
                if (colStat) colStat.innerText = Math.round(collisionCount / 0.5);
                if (speedStat) speedStat.innerText = (totalVX / particles.length).toFixed(1);
                const efficiency = Math.max(0, 100 - (collisionCount * 2 / particles.length)).toFixed(0);
                if (effStat) effStat.innerText = efficiency + "%";
                collisionCount = 0;
            }

            requestAnimationFrame(animate);
        }

        let currentStepNum = 0;
        const stepsData = [
            {
                title: "1. The Atomic scale",
                text: `<p>Resistance isn't just a numberâ€”it's <strong>friction</strong> at the atomic scale. An electron doesn't just "go through" a wire; it fights for every millimeter.</p>
                       <p>Watch the electrons (neon blue) try to navigate the grid of atoms. Notice how they gain speed from the voltage, only to lose it in a crash.</p>`,
                setup: () => {
                    statsOverlay.style.opacity = '0';
                    document.getElementById('dynamic-controls').innerHTML = '';
                    temp = 0;
                    voltage = 15;
                }
            },
            {
                title: "2. Joule Heating",
                text: `<p>Every time an electron crashes into an atom, its kinetic energy transforms into atomic vibrations. We call these vibrations <strong>HEAT</strong>.</p>
                       <div class="concept-block">
                           Watch the atoms glow red as they absorb the impact energy. This is why your phone gets warm when carrying high current!
                       </div>`,
                setup: () => {
                    statsOverlay.style.opacity = '1';
                }
            },
            {
                title: "3. The Heat Penalty",
                text: `<p>As you increase the <strong>Heat</strong>, the atoms vibrate faster. This makes them "larger" targets for the moving electrons.</p>
                       <p>Use the slider to heat up the lattice. Notice how the collision rate goes up and the net speed drops. This is why most metals increase in resistance as they get hot.</p>`,
                setup: () => {
                    document.getElementById('dynamic-controls').innerHTML = `
                        <div class="control-group">
                            <label>Lattice Heat <span id="t-label">Low</span></label>
                            <input type="range" id="t-slider" class="slider" min="0" max="25" step="1" value="2" oninput="updateParams()">
                        </div>
                    `;
                    updateParams();
                }
            },
            {
                title: "4. Imperfections",
                text: `<p>Real materials aren't mathematically perfect crystals. Small defects or "impurities" in the structure act like extra obstacles.</p>
                       <p>Add some impurities (neon green) and watch how they permanently disrupt the flow, even if the material is cold.</p>`,
                setup: () => {
                    document.getElementById('dynamic-controls').innerHTML += `
                        <div class="btn-group" style="margin-top: 20px;">
                            <button class="action-btn" onclick="addImpurity()">Add Impurity</button>
                            <button class="action-btn" onclick="resetSim()">Clear All</button>
                        </div>
                    `;
                }
            },
            {
                title: "Conclusion",
                text: `<p>You now have all the parameters of a conductor at your fingertips. Experiment with high voltage vs. high heat.</p>
                       <p>Can you find the limit where the material becomes so restrictive that current practically stops?</p>`,
                setup: () => {
                    document.getElementById('dynamic-controls').innerHTML = `
                        <div class="control-group">
                            <label>Voltage (Push) <span id="v-label">15V</span></label>
                            <input type="range" id="v-slider" class="slider" min="5" max="50" step="1" value="15" oninput="updateParams()">
                        </div>
                        <div class="control-group">
                            <label>Lattice Heat <span id="t-label">Low</span></label>
                            <input type="range" id="t-slider" class="slider" min="0" max="25" step="1" value="2" oninput="updateParams()">
                        </div>
                        <div class="btn-group">
                            <button class="action-btn" onclick="addImpurity()">Add Impurity</button>
                            <button class="action-btn" onclick="resetSim()">Clear All</button>
                        </div>
                    `;
                    updateParams();
                    document.getElementById('btn-next').innerText = "Next Lesson";
                }
            }
        ];

        function nextStep() {
            if (currentStepNum < stepsData.length - 1) {
                loadStep(currentStepNum + 1);
            } else {
                window.location.href = '/theapplefalls/lessons/chapter8/9_series_parallel.html';
            }
        }

        function loadStep(idx) {
            currentStepNum = idx;
            const s = stepsData[idx];
            document.getElementById('story-container').innerHTML = `<div class="chapter-title">${s.title}</div><div class="text-content">${s.text}</div>`;

            const btn = document.getElementById('btn-next');
            if (currentStepNum === stepsData.length - 1) {
                btn.innerHTML = "Next Lesson";
            } else {
                btn.innerHTML = "Next";
            }

            if (window.renderMathInElement) renderMathInElement(document.getElementById('story-container'));
            s.setup();
        }

        window.addEventListener('resize', resize);
        resize();
        loadStep(0);
        animate();
    </script>
</body>

</html>