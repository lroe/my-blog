<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Maxwell's Notebook: The Dipole Probe</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        /* --- THEME & LAYOUT --- */
        :root {
            --bg: #151515;
            --panel: #1e1e1e;
            --text: #dcdcdc;
            --accent: #ff9f43;
            /* Orange */
            --accent-hover: #e58e3c;
            --border: #333;
        }

        body {
            margin: 0;
            height: 100vh;
            display: flex;
            background: var(--bg);
            color: var(--text);
            font-family: 'Segoe UI', sans-serif;
            overflow: hidden;
        }

        /* SCROLLBAR */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg);
        }

        ::-webkit-scrollbar-thumb {
            background: #333;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #444;
        }

        /* LEFT PANEL: THE STORYBOOK */
        aside {
            width: 420px;
            background: var(--panel);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            box-shadow: 10px 0 30px rgba(0, 0, 0, 0.5);
            z-index: 10;
        }

        header {
            padding: 20px;
            border-bottom: 1px solid var(--border);
            background: rgba(0, 0, 0, 0.2);
        }

        h1 {
            margin: 0;
            font-size: 20px;
            color: var(--accent);
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .subtitle {
            font-size: 12px;
            color: #777;
            margin-top: 5px;
            font-style: italic;
        }

        #story-container {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .chapter-title {
            font-size: 24px;
            font-weight: 300;
            color: #fff;
            margin-bottom: 20px;
            border-left: 4px solid var(--accent);
            padding-left: 15px;
        }

        .story-text {
            line-height: 1.8;
            font-size: 15px;
            color: #ccc;
            margin-bottom: 20px;
        }

        .story-text strong {
            color: #fff;
            font-weight: 600;
        }

        .instruction-inline {
            color: var(--accent);
            font-weight: bold;
            background: rgba(255, 159, 67, 0.1);
            padding: 2px 5px;
            border-radius: 4px;
        }

        .math-block {
            background: #222;
            padding: 10px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            margin: 10px 0;
            border: 1px solid #333;
            color: #fff;
            text-align: center;
        }

        /* CONTROLS AREA */
        #controls-area {
            background: #181818;
            padding: 20px;
            border-top: 1px solid var(--border);
        }

        .control-row {
            margin-bottom: 15px;
            opacity: 0.5;
            pointer-events: none;
            transition: 0.3s;
            filter: grayscale(1);
        }

        .control-row.active {
            opacity: 1;
            pointer-events: all;
            filter: grayscale(0);
        }

        label {
            display: block;
            font-size: 11px;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
        }

        button {
            background: #333;
            color: #aaa;
            border: 1px solid #444;
            padding: 10px 15px;
            cursor: pointer;
            border-radius: 4px;
            font-size: 13px;
            transition: all 0.2s;
            width: 100%;
            text-transform: uppercase;
            font-weight: bold;
        }

        button:hover {
            background: #444;
            color: #fff;
        }

        input[type=range] {
            width: 100%;
            accent-color: var(--accent);
            cursor: pointer;
            height: 6px;
            background: #333;
            border-radius: 3px;
        }

        /* NAVIGATION FOOTER */
        #nav-footer {
            padding: 20px;
            display: flex;
            justify-content: space-between;
            border-top: 1px solid var(--border);
            background: #222;
        }

        .nav-btn {
            width: 48%;
            background: #333;
            color: #fff;
            border: none;
        }

        /* NEXT BUTTON STYLING FIX */
        .nav-btn.next {
            background: var(--accent);
            color: #151515;
            border: none;
        }

        .nav-btn.next:hover {
            background: var(--accent-hover);
            color: #000;
        }

        .nav-btn.next:disabled {
            background: #333;
            color: #555;
            cursor: not-allowed;
            opacity: 0.5;
            box-shadow: none;
            transform: none;
            animation: none;
        }

        main {
            flex: 1;
            position: relative;
            background: radial-gradient(circle at center, #23252e 0%, #0f1014 100%);
            overflow: hidden;
        }

        .scene-tag {
            position: absolute;
            color: rgba(255, 255, 255, 0.4);
            font-size: 12px;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 2px;
            pointer-events: none;
        }

        /* Tooltip for the Dipole */
        #dipole-readout {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.5);
            padding: 10px;
            border-left: 2px solid var(--accent);
            color: #fff;
            font-family: monospace;
            font-size: 12px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.5s;
        }

        #dipole-readout.visible {
            opacity: 1;
        }
    </style>
</head>

<body>

    <aside>
        <header>
            <h1>Maxwell's Notebook</h1>
            <div class="subtitle">Experiment: Mapping the Generator</div>
        </header>

        <div id="story-container">
            <div id="chapter-content">
                <!-- Content injected by JS -->
            </div>
        </div>

        <div id="controls-area">
            <!-- 1. Introduce Dipole -->
            <div class="control-row" id="ctrl-intro">
                <label>Step 1: The "Fishing Rod"</label>
                <button id="btn-intro" onclick="introduceDipole()">Equip Dipole Probe</button>
            </div>

            <!-- 2. Orbit Slider -->
            <div class="control-row" id="ctrl-orbit">
                <label>Step 2: Walk Around (Orbit)</label>
                <input type="range" id="slider-orbit" min="0" max="360" value="0" step="1">
            </div>

            <!-- 3. Polarity Switch -->
            <div class="control-row" id="ctrl-polarity">
                <label>Step 3: Analyze Polarity</label>
                <button id="btn-polarity" onclick="togglePolarity()">Swap Generator Polarity (+ / -)</button>
            </div>

            <!-- Reset -->
            <div class="control-row" id="ctrl-reset"
                style="margin-top:10px; border-top:1px solid #2c313a; padding-top:15px; opacity: 1; pointer-events: all; filter: grayscale(0);">
                <label>Experiment Control</label>
                <button onclick="resetSim()">Reset System</button>
            </div>
        </div>

        <div id="nav-footer">
            <button class="nav-btn" onclick="prevLesson()">Back</button>
            <button class="nav-btn next" id="btn-next" onclick="nextLesson()">Next &rarr;</button>
        </div>
    </aside>

    <main id="world">
        <div class="scene-tag" style="top: 20px; right: 20px;">Lab Space (Vacuum)</div>
        <div id="dipole-readout">
            TORQUE: DETECTED<br>
            ALIGNMENT: RADIAL
        </div>
    </main>

    <script>
        // ==========================================
        // PART 1: THE 3D ENGINE
        // ==========================================

        const state = {
            dipoleVisible: false,
            angle: 0,         // Orbit angle around VdG
            distance: 12,     // Radius from VdG
            sourcePolarity: 1, // 1 for Positive, -1 for Negative
            time: 0
        };

        const scene = new THREE.Scene();

        const sidebarWidth = 420;
        let aspect = (window.innerWidth - sidebarWidth) / window.innerHeight;
        const viewSize = 35;

        const camera = new THREE.OrthographicCamera(
            -viewSize * aspect / 2, viewSize * aspect / 2,
            viewSize / 2, -viewSize / 2,
            1, 1000
        );

        camera.position.set(20, 20, 20);
        camera.lookAt(0, 0, 0);

        const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setSize(window.innerWidth - sidebarWidth, window.innerHeight);
        renderer.shadowMap.enabled = true;
        renderer.shadowMap.type = THREE.PCFSoftShadowMap;
        document.getElementById('world').appendChild(renderer.domElement);

        // Lights
        const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
        scene.add(ambientLight);
        const dirLight = new THREE.DirectionalLight(0xffffff, 0.8);
        dirLight.position.set(10, 20, 5);
        dirLight.castShadow = true;
        dirLight.shadow.mapSize.width = 1024;
        dirLight.shadow.mapSize.height = 1024;
        scene.add(dirLight);

        // Floor
        const floorGeo = new THREE.PlaneGeometry(100, 100);
        const floorMat = new THREE.MeshStandardMaterial({ color: 0x222222, roughness: 0.9 });
        const floor = new THREE.Mesh(floorGeo, floorMat);
        floor.rotation.x = -Math.PI / 2;
        floor.position.y = -8;
        floor.receiveShadow = true;
        scene.add(floor);
        scene.background = new THREE.Color(0x151515);

        const gridHelper = new THREE.GridHelper(100, 20, 0x2c313a, 0x1f2229);
        gridHelper.position.y = -7.9;
        scene.add(gridHelper);

        // --- OBJECTS ---

        // 1. The VandeGraaff Generator (Source)
        const vdgGroup = new THREE.Group();

        // Dome
        const domeGeo = new THREE.IcosahedronGeometry(4, 2);
        const domeMat = new THREE.MeshStandardMaterial({
            color: 0xcccccc,
            metalness: 0.6,
            roughness: 0.2,
            emissive: 0x222222
        });
        const dome = new THREE.Mesh(domeGeo, domeMat);
        dome.castShadow = true;

        // Column
        const colGeo = new THREE.CylinderGeometry(1.5, 1.5, 12, 16);
        const colMat = new THREE.MeshStandardMaterial({ color: 0x333333 });
        const col = new THREE.Mesh(colGeo, colMat);
        col.position.y = -6;
        col.receiveShadow = true;

        vdgGroup.add(col);
        vdgGroup.add(dome);
        scene.add(vdgGroup);

        // Text Sprite Helper
        function createTextSprite(text, color = "#ffffff") {
            const canvas = document.createElement('canvas');
            canvas.width = 256; canvas.height = 128;
            const ctx = canvas.getContext('2d');
            ctx.font = 'bold 60px Arial';
            ctx.fillStyle = color;
            ctx.textAlign = "center";
            ctx.fillText(text, 128, 80);
            const tex = new THREE.CanvasTexture(canvas);
            const mat = new THREE.SpriteMaterial({ map: tex });
            const sprite = new THREE.Sprite(mat);
            sprite.scale.set(6, 3, 1);
            return sprite;
        }

        const labelVDG = createTextSprite("VdG (+)", "#ff6b6b");
        labelVDG.position.y = 6;
        vdgGroup.add(labelVDG);

        // 2. The Dipole Probe (The "Fishing Rod")
        const dipoleGroup = new THREE.Group();

        // The Rod
        const rodGeo = new THREE.CylinderGeometry(0.1, 0.1, 4, 8);
        rodGeo.rotateZ(Math.PI / 2); // Lay flat on X
        const rodMat = new THREE.MeshStandardMaterial({ color: 0x888888 });
        const rod = new THREE.Mesh(rodGeo, rodMat);
        rod.castShadow = true;
        dipoleGroup.add(rod);

        // Positive Ball (Red)
        const ballGeo = new THREE.IcosahedronGeometry(0.6, 1);
        const posMat = new THREE.MeshStandardMaterial({ color: 0xff4757, emissive: 0x330000 });
        const posBall = new THREE.Mesh(ballGeo, posMat);
        posBall.position.x = 2; // Right end
        dipoleGroup.add(posBall);

        // Negative Ball (Blue)
        const negMat = new THREE.MeshStandardMaterial({ color: 0x2e86de, emissive: 0x001133 });
        const negBall = new THREE.Mesh(ballGeo, negMat);
        negBall.position.x = -2; // Left end
        dipoleGroup.add(negBall);

        // Label Pointers on Dipole
        const labelPos = createTextSprite("+", "#ff4757");
        labelPos.scale.set(2, 1, 1);
        labelPos.position.set(2, 1.5, 0);
        dipoleGroup.add(labelPos);

        const labelNeg = createTextSprite("-", "#2e86de");
        labelNeg.scale.set(2, 1, 1);
        labelNeg.position.set(-2, 1.5, 0);
        dipoleGroup.add(labelNeg);

        scene.add(dipoleGroup);
        dipoleGroup.visible = false;

        // 3. Field Lines (Visual Aid)
        const linesGroup = new THREE.Group();
        const lineMat = new THREE.LineBasicMaterial({ color: 0x54a0ff, transparent: true, opacity: 0.15 });

        for (let i = 0; i < 16; i++) {
            const angle = (i / 16) * Math.PI * 2;
            const pts = [];
            pts.push(new THREE.Vector3(Math.cos(angle) * 4, 0, Math.sin(angle) * 4));
            pts.push(new THREE.Vector3(Math.cos(angle) * 20, 0, Math.sin(angle) * 20));
            const geo = new THREE.BufferGeometry().setFromPoints(pts);
            const line = new THREE.Line(geo, lineMat);
            linesGroup.add(line);
        }
        scene.add(linesGroup);
        linesGroup.visible = false;


        // ==========================================
        // PART 2: ANIMATION LOOP & PHYSICS
        // ==========================================

        function animate() {
            requestAnimationFrame(animate);
            state.time += 0.02;

            // VdG Pulse effect
            dome.scale.setScalar(1 + Math.sin(state.time * 2) * 0.01);

            if (state.dipoleVisible) {
                // 1. Position Dipole based on Orbit Slider
                const rad = state.angle * (Math.PI / 180);
                const x = Math.cos(rad) * state.distance;
                const z = Math.sin(rad) * state.distance;

                dipoleGroup.position.set(x, 0, z);

                // 2. CALCULATE TORQUE / ALIGNMENT
                // The field direction at position (x,0,z) is simply the vector (x,0,z) normalized.
                // Angle of field vector in XZ plane:
                let fieldAngle = Math.atan2(z, x);

                // If Source is NEGATIVE, field points INWARD.
                // A dipole aligns with field lines.
                // Positive end (Red, +x local) points along Field Vector.
                // If field is inward, Field Vector is (fieldAngle + PI).

                if (state.sourcePolarity === -1) {
                    // Field points IN. 
                    // We want the red ball (+ local x) to point IN.
                    // So dipole rotation should be fieldAngle + PI
                    dipoleGroup.rotation.y = -fieldAngle + Math.PI;
                } else {
                    // Field points OUT.
                    // Red ball (+ local x) points OUT.
                    dipoleGroup.rotation.y = -fieldAngle;
                }

                // Add a little oscillation to simulate "settling" physics
                dipoleGroup.rotation.y += Math.sin(state.time * 3) * 0.05;
            }

            renderer.render(scene, camera);
        }
        animate();

        // ==========================================
        // PART 3: LOGIC & NARRATIVE
        // ==========================================

        let currentChapter = 0;

        // --- Control Handlers ---

        function introduceDipole() {
            state.dipoleVisible = true;
            dipoleGroup.visible = true;
            document.getElementById('btn-intro').disabled = true;
            document.getElementById('dipole-readout').classList.add('visible');
            checkAdvance();
        }

        document.getElementById('slider-orbit').addEventListener('input', (e) => {
            state.angle = parseFloat(e.target.value);
            checkAdvance();
        });

        function togglePolarity() {
            state.sourcePolarity *= -1;

            // Update Visuals
            if (state.sourcePolarity === 1) {
                domeMat.emissive.setHex(0x222222); // Standard
                domeMat.color.setHex(0xcccccc);

                const ctx = labelVDG.material.map.image.getContext('2d');
                ctx.clearRect(0, 0, 256, 128);
                ctx.fillStyle = "#ff6b6b";
                ctx.fillText("VdG (+)", 128, 80);
                labelVDG.material.map.needsUpdate = true;
            } else {
                domeMat.emissive.setHex(0x001133); // Dark Blueish
                domeMat.color.setHex(0x54a0ff);

                const ctx = labelVDG.material.map.image.getContext('2d');
                ctx.clearRect(0, 0, 256, 128);
                ctx.fillStyle = "#54a0ff";
                ctx.fillText("VdG (-)", 128, 80);
                labelVDG.material.map.needsUpdate = true;
            }
            checkAdvance();
        }

        function resetSim() {
            state.dipoleVisible = false;
            state.sourcePolarity = 1; // reset to positive
            state.angle = 0;
            document.getElementById('slider-orbit').value = 0;

            dipoleGroup.visible = false;
            linesGroup.visible = false;

            document.getElementById('btn-intro').disabled = false;
            document.getElementById('dipole-readout').classList.remove('visible');

            // Reset label
            const ctx = labelVDG.material.map.image.getContext('2d');
            ctx.clearRect(0, 0, 256, 128);
            ctx.fillStyle = "#ff6b6b";
            ctx.fillText("VdG (+)", 128, 80);
            labelVDG.material.map.needsUpdate = true;
            domeMat.color.setHex(0xcccccc);

            loadLesson(0);
        }

        // --- LESSON CONTENT (First Principles) ---

        const lessons = [
            {
                title: "First Principles: The Setup",
                text: "We have a large conductor, the Van de Graaff Generator. It holds a massive net charge (Q).<br><br>First Principle: <strong>Charge alters the space around it.</strong><br><br>We cannot 'see' this alteration (the Electric Field) with our eyes. We need a tool that interacts with it. We will use a <strong>Dipole Probe</strong>—an insulating rod with opposite charges at the ends.",
                setup: () => {
                    lockAll();
                    unlock('ctrl-intro');
                },
                check: () => state.dipoleVisible
            },
            {
                title: "Mechanism: Torque",
                text: "You have introduced the dipole. Observe its behavior.<br><br>The <strong style='color:#ff4757'>Red End (+)</strong> is repelled by the Positive VdG.<br>The <strong style='color:#2e86de'>Blue End (-)</strong> is attracted to it.<br><br>Because these forces act on opposite ends of a rigid rod, they create a <strong>Torque</strong>. The rod rotates until the forces align. This alignment reveals the direction of the invisible field lines.",
                setup: () => {
                    unlock('ctrl-orbit');
                    linesGroup.visible = true; // Reveal lines to show alignment
                },
                check: () => Math.abs(state.angle - 0) > 20 // User moved it
            },
            {
                title: "Mapping: Radial Geometry",
                text: "By moving the probe around the generator (<span class='instruction-inline'>Use the Slider</span>), we map the field geometry.<br><br>Notice that no matter where you stand, the dipole always points <strong>Radially</strong> (directly away from the center).<br><br>This confirms that the Electric Field of a sphere is spherically symmetric. The 'Fishing Rod' always points along the radius.",
                setup: () => {
                    // Just keep orbit unlocked
                },
                check: () => state.angle > 90 // User moved it significantly
            },
            {
                title: "Conclusion",
                text: "This probe is useful for unknowns. What if we didn't know the VdG was positive?<br><br>If we swap the generator to <strong>Negative</strong>, the field vectors flip direction (pointing inward).<br><br>The Dipole obeys: The (+) end must point <em>with</em> the field (inward). Watch the probe flip 180° when you toggle the polarity. Now that we've mapped the field with a single probe, let's visualize the entire field at once using thousands of tiny probes: Grass Seeds.",
                setup: () => {
                    unlock('ctrl-polarity');
                },
                check: () => state.sourcePolarity === -1
            }
        ];

        function loadLesson(idx) {
            currentChapter = idx;
            const l = lessons[idx];
            document.querySelector('header .subtitle').innerText = `Lesson ${idx + 1}: ${l.title}`;
            document.getElementById('chapter-content').innerHTML =
                `<div class="chapter-title">${l.title}</div>
             <div class="story-text">${l.text}</div>`;

            const btn = document.getElementById('btn-next');

            if (currentChapter === lessons.length - 1) {
                btn.innerHTML = "Next Lesson &rarr;";
                btn.disabled = false;
            } else {
                btn.innerHTML = "Next &rarr;";
                btn.disabled = !l.check();
            }

            l.setup();
        }

        function nextLesson() {
            if (currentChapter < lessons.length - 1) {
                loadLesson(currentChapter + 1);
            } else {
                window.top.location.href = '/theapplefalls/lesson/9_dipole_on_grassfield';
            }
        }
        function prevLesson() {
            if (currentChapter > 0) loadLesson(currentChapter - 1);
        }
        function checkAdvance() {
            if (currentChapter >= lessons.length - 1) return;
            if (lessons[currentChapter].check()) {
                document.getElementById('btn-next').disabled = false;
            }
        }

        function lockAll() { document.querySelectorAll('.control-row').forEach(r => r.classList.remove('active')); }
        function unlock(id) { document.getElementById(id).classList.add('active'); }

        // Init
        loadLesson(0);

        // Resize Handle
        window.addEventListener('resize', () => {
            const newAspect = (window.innerWidth - sidebarWidth) / window.innerHeight;
            camera.left = -viewSize * newAspect / 2;
            camera.right = viewSize * newAspect / 2;
            camera.top = viewSize / 2;
            camera.bottom = -viewSize / 2;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth - sidebarWidth, window.innerHeight);
        });

    </script>
</body>

</html>