<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Maxwell's Notebook: Atomic Induction</title>
    <!-- Load Three.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <!-- Load OrbitControls -->
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <!-- Load KaTeX -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/katex.min.css">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/katex.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/contrib/auto-render.min.js"
        onload="renderMathInElement(document.body);"></script>

    <style>
        :root {
            --bg: #151515;
            --panel: #1e1e1e;
            --text: #dcdcdc;
            --accent: #ff9f43;
            /* Maxwell Orange */
            --accent-hover: #e58e3c;
            --positive: #ff5252;
            /* Red for Nucleus */
            --electron: #0984e3;
            /* Blue for Cloud */
            --border: #333;
        }

        body {
            margin: 0;
            height: 100vh;
            display: flex;
            background: var(--bg);
            color: var(--text);
            font-family: 'Segoe UI', sans-serif;
            overflow: hidden;
        }

        /* --- SIDEBAR --- */
        aside {
            width: 420px;
            background: var(--panel);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            z-index: 10;
            box-shadow: 10px 0 30px rgba(0, 0, 0, 0.8);
        }

        header {
            padding: 20px;
            background: rgba(0, 0, 0, 0.2);
            border-bottom: 1px solid var(--border);
        }

        h1 {
            margin: 0;
            font-size: 18px;
            color: var(--accent);
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .subtitle {
            font-size: 12px;
            color: #888;
            margin-top: 5px;
        }

        #story-container {
            flex: 1;
            padding: 25px;
            overflow-y: auto;
        }

        .chapter-title {
            font-size: 22px;
            color: #fff;
            margin-bottom: 15px;
            border-left: 3px solid var(--accent);
            padding-left: 10px;
        }

        .text-content {
            line-height: 1.6;
            font-size: 14px;
            color: #ccc;
            text-align: justify;
            margin-bottom: 15px;
        }

        .text-content strong {
            color: #fff;
        }

        .text-content em {
            color: var(--accent);
            font-style: normal;
        }

        .math-block {
            background: #222;
            padding: 15px;
            border-radius: 4px;
            border: 1px solid #333;
            font-size: 1.1em;
            text-align: center;
            margin: 20px 0;
            color: var(--accent);
        }

        /* --- CONTROLS --- */
        #controls {
            background: #111;
            padding: 20px;
            border-top: 1px solid var(--border);
        }

        button {
            background: #2a2a2a;
            color: #fff;
            border: 1px solid #444;
            padding: 12px;
            width: 100%;
            cursor: pointer;
            font-weight: bold;
            transition: 0.2s;
            text-transform: uppercase;
            font-size: 12px;
            margin-bottom: 10px;
        }

        button:hover {
            background: var(--accent);
            color: #111;
            border-color: var(--accent);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            filter: grayscale(1);
            box-shadow: none;
        }

        /* Navigation Buttons */
        #nav {
            padding: 15px;
            display: flex;
            gap: 10px;
            background: #000;
            border-top: 1px solid var(--border);
        }

        .nav-btn {
            flex: 1;
            margin: 0;
        }

        .next-btn {
            background: var(--accent);
            color: #111;
            border: none;
        }

        .next-btn:hover {
            background: #ffb875;
        }

        input[type=range] {
            width: 100%;
            margin: 10px 0;
            accent-color: var(--accent);
        }

        label {
            font-size: 12px;
            text-transform: uppercase;
            color: #888;
            display: block;
            margin-top: 10px;
        }

        /* --- VIEWPORT --- */
        main {
            flex: 1;
            position: relative;
            background: radial-gradient(circle at center, #1a1a1a 0%, #000 100%);
            overflow: hidden;
        }

        /* OVERLAYS */
        .overlay-label {
            position: absolute;
            color: white;
            font-weight: bold;
            text-shadow: 0 0 10px #000;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.5s;
            font-family: monospace;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        #plate-pos {
            top: 45%;
            left: 40px;
            color: var(--positive);
            font-size: 18px;
            text-align: center;
        }

        #plate-neg {
            top: 45%;
            right: 40px;
            color: var(--electron);
            font-size: 18px;
            text-align: center;
        }
    </style>
</head>

<body>

    <aside>
        <header>
            <h1>Maxwell's Notebook</h1>
            <div class="subtitle">Chapter 7: Atomic Induction</div>
        </header>

        <div id="story-container">
            <!-- Content injected via JS -->
        </div>

        <div id="controls">
            <div id="dynamic-controls"></div>
        </div>
        <div id="nav">
            <button class="nav-btn" onclick="prevStep()">Back</button>
            <button class="nav-btn next-btn" id="btn-next" onclick="nextStep()">Next</button>
        </div>
    </aside>

    <main id="viewport">
        <!-- CSS Labels for the Surface Charges -->
        <div id="plate-pos" class="overlay-label">
            Neg. Surface<br>Charge<br>(- - -)
        </div>
        <div id="plate-neg" class="overlay-label">
            Pos. Surface<br>Charge<br>(+ + +)
        </div>
    </main>

    <script>
        // --- THREE.JS SETUP ---
        const viewport = document.getElementById('viewport');
        const scene = new THREE.Scene();

        // Camera setup for a "Textbook" view (front-facing)
        const camera = new THREE.PerspectiveCamera(40, viewport.offsetWidth / viewport.offsetHeight, 0.1, 100);
        camera.position.set(0, 0, 18);

        const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setSize(viewport.offsetWidth, viewport.offsetHeight);
        renderer.setPixelRatio(window.devicePixelRatio);
        viewport.appendChild(renderer.domElement);

        const orbit = new THREE.OrbitControls(camera, renderer.domElement);
        orbit.enableDamping = true;
        orbit.enablePan = false;
        orbit.target.set(0, 0, 0);

        // Lights
        const ambLight = new THREE.AmbientLight(0xffffff, 0.5);
        scene.add(ambLight);
        const dirLight = new THREE.DirectionalLight(0xffffff, 1.0);
        dirLight.position.set(5, 10, 7);
        scene.add(dirLight);

        // --- OBJECTS ---

        // 1. Field Arrows (The External E-Field)
        const fieldGroup = new THREE.Group();
        scene.add(fieldGroup);

        function createFieldArrows() {
            for (let x = -8; x <= 8; x += 4) {
                for (let y = -4; y <= 4; y += 2.5) {
                    const dir = new THREE.Vector3(1, 0, 0);
                    const origin = new THREE.Vector3(-10, y, 0);
                    const length = 20;
                    // Yellow/Orange for E-Field to match Notebook Theme
                    const color = 0xffdd59;
                    const arrowHelper = new THREE.ArrowHelper(dir, origin, length, color, 1, 0.5);

                    // Start invisible
                    arrowHelper.line.material.opacity = 0;
                    arrowHelper.line.material.transparent = true;
                    arrowHelper.cone.material.transparent = true;
                    arrowHelper.cone.material.opacity = 0;
                    fieldGroup.add(arrowHelper);
                }
            }
        }
        createFieldArrows();

        // 2. The Atom Factory
        const atomRadius = 0.8;
        const nucleusRadius = 0.2;

        // Materials
        // Blue for electrons (standard physics), Red for protons
        const cloudMat = new THREE.MeshPhysicalMaterial({
            color: 0x0984e3, transparent: true, opacity: 0.4,
            roughness: 0, transmission: 0.2, thickness: 1.0, side: THREE.DoubleSide
        });
        const nucleusMat = new THREE.MeshStandardMaterial({
            color: 0xff5252, emissive: 0x550000, roughness: 0.3
        });

        const atoms = []; // Store references for animation
        const atomGridGroup = new THREE.Group();
        scene.add(atomGridGroup);

        function createAtom(x, y, z) {
            const atomRoot = new THREE.Group();
            atomRoot.position.set(x, y, z);

            // Positive Nucleus (Center)
            const nucleus = new THREE.Mesh(new THREE.SphereGeometry(nucleusRadius, 16, 16), nucleusMat);
            atomRoot.add(nucleus);

            // Negative Electron Cloud
            const cloud = new THREE.Mesh(new THREE.SphereGeometry(atomRadius, 32, 32), cloudMat.clone());
            atomRoot.add(cloud);

            atomGridGroup.add(atomRoot);

            return { root: atomRoot, nucleus: nucleus, cloud: cloud, baseX: x, baseY: y };
        }

        // Create the Grid (Dielectric Material)
        // 5 Columns, 3 Rows
        const spacing = 1.9; // Just enough so they almost touch
        for (let i = 0; i < 5; i++) {
            for (let j = 0; j < 3; j++) {
                const x = (i - 2) * spacing;
                const y = (j - 1) * spacing;
                atoms.push(createAtom(x, y, 0));
            }
        }

        // 3. Surface Charge Highlighters (Glow planes at ends)
        const highlightGeo = new THREE.PlaneGeometry(0.5, 6);
        // Use Blue/Red for the surface charges to distinguish polarity
        const posHighMat = new THREE.MeshBasicMaterial({ color: 0xff5252, transparent: true, opacity: 0.0, side: THREE.DoubleSide, blending: THREE.AdditiveBlending });
        const negHighMat = new THREE.MeshBasicMaterial({ color: 0x0984e3, transparent: true, opacity: 0.0, side: THREE.DoubleSide, blending: THREE.AdditiveBlending });

        // Note: If E-Field points RIGHT, Nuclei (Pos) push RIGHT, Clouds (Neg) push LEFT.
        // So Left Surface = Negative, Right Surface = Positive.
        const leftSurface = new THREE.Mesh(highlightGeo, negHighMat);
        leftSurface.position.set(-4.2, 0, 0);
        scene.add(leftSurface);

        const rightSurface = new THREE.Mesh(highlightGeo, posHighMat);
        rightSurface.position.set(4.2, 0, 0);
        scene.add(rightSurface);


        // --- SIMULATION STATE ---
        let E_Field = 0.0; // 0 to 1
        let showGrid = false; // Toggle for single atom vs grid

        function updatePhysics() {
            // Update Field Arrows
            fieldGroup.children.forEach(arrow => {
                arrow.line.material.opacity = E_Field * 0.4;
                arrow.cone.material.opacity = E_Field * 0.4;
            });

            // Update Atoms
            atoms.forEach((atom, index) => {
                // Logic: F = qE
                // Positive nucleus pushed Right (direction of E)
                // Negative cloud pulled Left (opposite to E)

                const maxShift = 0.55; // Max displacement

                // Shift Cloud Left
                atom.cloud.position.x = -E_Field * maxShift;

                // Stretch Cloud (Prolate Spheroid)
                // Volume conservation approx: x increases, y/z decrease
                const stretch = 1 + (E_Field * 0.3);
                const squash = 1 / Math.sqrt(stretch);
                atom.cloud.scale.set(stretch, squash, squash);

                // Opacity Logic for "Cancellation" visual
                // When Grid is active, inner parts look denser
                if (showGrid) {
                    atom.cloud.material.opacity = 0.3 + (E_Field * 0.2);
                } else {
                    atom.cloud.material.opacity = 0.4;
                }
            });

            // Update Surface Charge Indicators
            if (showGrid && E_Field > 0.1) {
                // The left surface accumulates negative charge (clouds shift left)
                leftSurface.material.opacity = (E_Field - 0.1) * 0.5;
                // The right surface accumulates positive charge (nuclei exposed right)
                rightSurface.material.opacity = (E_Field - 0.1) * 0.5;

                document.getElementById('plate-pos').style.opacity = E_Field > 0.2 ? 1 : 0;
                document.getElementById('plate-neg').style.opacity = E_Field > 0.2 ? 1 : 0;
            } else {
                leftSurface.material.opacity = 0;
                rightSurface.material.opacity = 0;
                document.getElementById('plate-pos').style.opacity = 0;
                document.getElementById('plate-neg').style.opacity = 0;
            }
        }

        function animate() {
            requestAnimationFrame(animate);
            updatePhysics();
            orbit.update();
            renderer.render(scene, camera);
        }
        animate();


        // --- STORY ENGINE ---
        const steps = [
            {
                title: "1. The Neutral Atom",
                text: `Let's begin from first principles with a single atom of an insulator.<br><br>The <span style="color:#ff5252">Red</span> center is the positive nucleus. The <span style="color:#0984e3">Blue</span> sphere is the electron cloud surrounding it.<br><br>In the absence of an external field, the centers of positive and negative charge perfectly overlap. The atom has <strong>zero net dipole moment</strong>.`,
                controls: `<div style="text-align:center; padding:10px; color:#666">No External Field</div>`,
                setup: () => {
                    showGrid = false;
                    E_Field = 0;
                    toggleGridVisibility(false);
                }
            },
            {
                title: "2. Applying Force",
                text: `Now, let's apply an External Electric Field ($\vec{E}$) pointing to the right (Yellow Arrows).<br><br>Recall the force law: $\vec{F} = q\vec{E}$.
            <ul>
                <li>The <span style="color:#ff5252">Nucleus (+)</span> is pushed <strong>with</strong> the field (Right).</li>
                <li>The <span style="color:#0984e3">Electron Cloud (-)</span> is pulled <strong>against</strong> the field (Left).</li>
            </ul>
            Use the slider to increase the field strength. Notice how the atom stretches.`,
                controls: `
                <label>External Field Strength (E)</label>
                <input type="range" min="0" max="1" step="0.01" value="0" oninput="E_Field = parseFloat(this.value)">
            `,
                setup: () => {
                    showGrid = false;
                    toggleGridVisibility(false);
                }
            },
            {
                title: "3. The Induced Dipole",
                text: `The atom is now <strong>Polarized</strong>. It has become a tiny dipole.<br><br>Even though the atom remains neutral overall, the separation of charge creates a <em>Dipole Moment</em> ($\vec{p}$):
            <div class="math-block">$$ \vec{p} = \alpha \vec{E} $$</div>
            where $\alpha$ is the atomic polarizability. The stronger the field, the more the atom stretches.`,
                controls: `
                <label>External Field Strength (E)</label>
                <input type="range" min="0" max="1" step="0.01" value="0.5" oninput="E_Field = parseFloat(this.value)">
            `,
                setup: () => {
                    showGrid = false;
                    E_Field = 0.5;
                    toggleGridVisibility(false);
                }
            },
            {
                title: "4. The Material Scale",
                text: `Real materials are collections of billions of these atoms. Let's zoom out to see a grid of them.<br><br>Initially, with zero field, they are all relaxed. Watch what happens to the collection as we increase the field.`,
                controls: `
                <label>External Field Strength (E)</label>
                <input type="range" min="0" max="1" step="0.01" value="0" oninput="E_Field = parseFloat(this.value)">
            `,
                setup: () => {
                    showGrid = true;
                    E_Field = 0;
                    toggleGridVisibility(true);
                }
            },
            {
                title: "Conclusion",
                text: `This is the key insight. Look at the <strong>Interior</strong> of the material: The negative tail of one atom overlaps the positive head of its neighbor. They cancel out.<br><br>But look at the <strong>Edges</strong>:<br>
            On the Left: Electron clouds stick out uncancelled.<br>
            On the Right: Nuclei are exposed uncancelled.<br><br>
            This accumulation is called <strong>Bound Surface Charge</strong>. It creates an internal field that opposes the external one.`,
                controls: `
                <label>External Field Strength (E)</label>
                <input type="range" min="0" max="1" step="0.01" value="0.8" oninput="E_Field = parseFloat(this.value)">
            `,
                setup: () => {
                    showGrid = true;
                    E_Field = 0.8;
                    toggleGridVisibility(true);
                    document.getElementById('btn-next').innerText = "Next Lesson";
                    document.getElementById('btn-next').disabled = false;
                }
            }
        ];

        function toggleGridVisibility(show) {
            atoms.forEach((atom, idx) => {
                // If show is false, only show the center atom (index 7 in a 5x3 grid is middle)
                const isCenter = (idx === 7);
                atom.root.visible = show ? true : isCenter;

                // Reset position if switching to single view to center it
                if (!show && isCenter) {
                    atom.root.position.set(0, 0, 0);
                    // Scale up the single atom for better visibility
                    atom.root.scale.set(1.5, 1.5, 1.5);
                } else {
                    atom.root.position.set(atom.baseX, atom.baseY, 0);
                    atom.root.scale.set(1, 1, 1);
                }
            });
        }

        let currentStep = 0;

        function loadStep(idx) {
            currentStep = idx;
            const s = steps[idx];
            document.getElementById('story-container').innerHTML = `
            <div class="chapter-title">${s.title}</div>
            <div class="text-content">${s.text}</div>
        `;
            document.getElementById('dynamic-controls').innerHTML = s.controls;

            renderMathInElement(document.getElementById('story-container'), {
                delimiters: [{ left: "$$", right: "$$", display: true }, { left: "$", right: "$", display: false }]
            });

            if (s.setup) s.setup();

            const btn = document.getElementById('btn-next');
            if (currentStep === steps.length - 1) {
                btn.innerHTML = "Next Lesson";
                btn.disabled = false;
            } else {
                btn.innerHTML = "Next";
                btn.disabled = false;
            }
        }

        function nextStep() {
            if (currentStep < steps.length - 1) {
                loadStep(currentStep + 1);
            } else {
                window.parent.location.href = '/lesson/chapter7/dielectric_constant';
            }
        }
        function prevStep() { if (currentStep > 0) loadStep(currentStep - 1); }

        // Init
        loadStep(0);

        // Resize Handler
        window.addEventListener('resize', () => {
            camera.aspect = viewport.offsetWidth / viewport.offsetHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(viewport.offsetWidth, viewport.offsetHeight);
        });

    </script>
</body>

</html>